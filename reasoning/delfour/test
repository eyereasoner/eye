#!/usr/bin/env bash
set -euo pipefail

# --- config / setup ---------------------------------------------------
SESSION="${1:-S1}"
OUTDIR="bus/$SESSION"
mkdir -p "$OUTDIR"

# Resolve repo dir (location of this script) to find phone.n3 / scanner.n3
HERE="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Single, conservative EYE flag set (no probing):
EYE_FLAGS=(--quiet --nope --pass-only-new)

# Check EYE
if ! command -v eye >/dev/null 2>&1; then
  echo "ERROR: EYE not found in PATH. Install EYE and retry." >&2
  exit 1
fi

# --- time helpers (GNU date or Python fallback) -----------------------
iso_now() {
  if date -u +%Y-%m-%dT%H:%M:%SZ >/dev/null 2>&1; then
    date -u +%Y-%m-%dT%H:%M:%SZ
  else
    python3 - <<'PY'
from datetime import datetime, timezone
print(datetime.now(timezone.utc).strftime('%Y-%m-%dT%H:%M:%SZ'))
PY
  fi
}
iso_plus_hours() {
  local hrs="${1:-2}"
  if date -u -d "+${hrs} hours" +%Y-%m-%dT%H:%M:%SZ >/dev/null 2>&1; then
    date -u -d "+${hrs} hours" +%Y-%m-%dT%H:%M:%SZ
  else
    python3 - "$hrs" <<'PY'
import sys
from datetime import datetime, timedelta, timezone
hrs=float(sys.argv[1])
print((datetime.now(timezone.utc)+timedelta(hours=hrs)).strftime('%Y-%m-%dT%H:%M:%SZ'))
PY
  fi
}

#CREATED_AT="$(iso_now)"
#EXPIRES_AT="$(iso_plus_hours 2)"
#NOW_TS="$(iso_now)"
CREATED_AT="2025-10-04T16:51:53Z"
EXPIRES_AT="2025-10-04T18:51:53Z"
NOW_TS="2025-10-04T16:51:53Z"

# --- 1) write input graphs -------------------------------------------
cat >"$OUTDIR/profile.ttl" <<'TTL'
@prefix :       <https://example.org/person#> .
@prefix health: <https://example.org/health#> .

:me  health:householdCondition  health:Diabetes .
TTL

cat >"$OUTDIR/context.ttl" <<TTL
@prefix ctx: <https://example.org/context#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .

[] ctx:retailer "Delfour" ;
   ctx:device   "self-scanner" ;
   ctx:event    "pick_up_scanner" ;
   ctx:createdAt "${CREATED_AT}"^^xsd:dateTime ;
   ctx:expiresAt "${EXPIRES_AT}"^^xsd:dateTime .
TTL

cat >"$OUTDIR/now.ttl" <<TTL
@prefix ex:  <https://example.org/enforce#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
[] ex:now "${NOW_TS}"^^xsd:dateTime .
TTL

cat >"$OUTDIR/request.ttl" <<'TTL'
@prefix odrl: <http://www.w3.org/ns/odrl/2/> .
@prefix req:  <https://example.org/request#> .

req:r1 odrl:action odrl:use ;
      odrl:constraint [
        odrl:leftOperand  odrl:purpose ;
        odrl:rightOperand "shopping_assist"
      ] .
TTL

cat >"$OUTDIR/catalog.ttl" <<'TTL'
@prefix prod:   <https://example.org/product#> .
@prefix schema: <http://schema.org/> .
@prefix xsd:    <http://www.w3.org/2001/XMLSchema#> .

prod:BIS_001 a schema:Product ; schema:name "Classic Tea Biscuits" ; schema:sugarContent "12.0"^^xsd:decimal .
prod:BIS_101 a schema:Product ; schema:name "Low-Sugar Tea Biscuits" ; schema:sugarContent "3.0"^^xsd:decimal .
prod:CHOC_050 a schema:Product ; schema:name "Milk Chocolate Bar"   ; schema:sugarContent "15.0"^^xsd:decimal .
prod:CHOC_150 a schema:Product ; schema:name "85% Dark Chocolate"   ; schema:sugarContent "6.0"^^xsd:decimal .
TTL

cat >"$OUTDIR/scan.ttl" <<'TTL'
@prefix shop: <https://example.org/shop#> .
@prefix prod: <https://example.org/product#> .

[] shop:scannedProduct prod:BIS_001 .
TTL

# --- 2) PHONE: derive neutral Insight + ODRL policy -------------------
echo "[phone] deriving neutral insight + policy …"
if ! eye "${EYE_FLAGS[@]}" \
    "$OUTDIR/profile.ttl" \
    "$OUTDIR/context.ttl" \
    "$HERE/phone.n3" \
    > "$OUTDIR/insight_policy.ttl"
then
  echo "ERROR: EYE failed during phone phase." >&2
  exit 2
fi

# --- 3) SCANNER: auth + audit + suggestion ---------------------------
echo "[scanner] running enforcement + suggestion …"
if ! eye "${EYE_FLAGS[@]}" \
    "$OUTDIR/insight_policy.ttl" \
    "$OUTDIR/now.ttl" \
    "$OUTDIR/request.ttl" \
    "$OUTDIR/catalog.ttl" \
    "$OUTDIR/scan.ttl" \
    "$HERE/scanner.n3" \
    > "$OUTDIR/scanner_out.n3"
then
  echo "ERROR: EYE failed during scanner phase." >&2
  exit 3
fi

# --- 4) tiny summary --------------------------------------------------
echo
echo "=== SUMMARY (session $SESSION) ==="
echo "Created:  $CREATED_AT"
echo "Expires:  $EXPIRES_AT"
echo "Now:      $NOW_TS"
echo

echo "- Insight & Policy:   $OUTDIR/insight_policy.ttl"
echo "- Scanner derivation: $OUTDIR/scanner_out.n3"
echo

# Outcome (Allowed/Blocked)
if grep -q 'act:outcome "Blocked"' "$OUTDIR/scanner_out.n3"; then
  echo "Decision: BLOCKED"
elif grep -q 'act:outcome "Allowed"' "$OUTDIR/scanner_out.n3"; then
  echo "Decision: ALLOWED"
else
  echo "Decision: (no explicit outcome found)"
fi

# Suggested alternative (if any)
ALT_LINE="$(grep -E 'shop:suggestedAlternative' "$OUTDIR/scanner_out.n3" || true)"
if [[ -n "$ALT_LINE" ]]; then
  echo "Suggestion: $ALT_LINE"
else
  echo "Suggestion: none"
fi

echo
echo "All files under: $OUTDIR/"

