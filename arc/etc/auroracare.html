<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AuroraCare ‚Äî Purpose-based Medical Data Exchange</title>
  <style>
    :root{--bg:#f7fafc;--panel:#ffffff;--muted:#475569;--text:#0b1220;--accent:#2563eb;--good:#16a34a;--bad:#dc2626;--warn:#d97706;--chip:#eef2f7}
    *{box-sizing:border-box} body{margin:0;font:16px/1.5 system-ui,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{padding:24px 20px;border-bottom:1px solid #e5e7eb;background:linear-gradient(180deg,rgba(37,99,235,.08),transparent)}
    h1{margin:0;font-size:24px;letter-spacing:.2px}
    main{display:grid;grid-template-columns:1fr;gap:22px;padding:20px;align-items:start}
    section{background:var(--panel);border:1px solid #e5e7eb;border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.06)}
    h2{margin:0 0 10px 0;font-size:18px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .grid{display:grid;gap:10px}
    .grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    label{display:inline-flex;align-items:center;gap:8px;background:var(--chip);padding:8px 10px;border-radius:999px;border:1px solid #dbe2ea}
    input[type="text"], select{background:#ffffff;border:1px solid #cbd5e1;color:var(--text);border-radius:10px;padding:10px 12px;width:100%}
    button{cursor:pointer;background:var(--accent);color:#fff;border:none;padding:10px 14px;border-radius:12px;font-weight:600}
    button.ghost{background:#f8fafc;color:var(--text);border:1px solid #dbe2ea}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;background:#ffffff;border:1px solid #e5e7eb}
    .small{font-size:13px;color:var(--muted)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .ok{color:var(--good)} .no{color:var(--bad)} .warn{color:var(--warn)}
    .kvs{display:grid;grid-template-columns:160px 1fr;gap:6px 10px}
    .log{max-height:260px;overflow:auto;background:#ffffff;border:1px solid #e5e7eb;border-radius:12px;padding:10px}
    .timeline{display:flex;flex-direction:column;gap:10px}
    .card{background:#ffffff;border:1px solid #e5e7eb;border-radius:12px;padding:12px}
    .muted{color:var(--muted)}
    .split{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center}
    .btnrow{display:flex;gap:10px;flex-wrap:wrap}
    .right{display:flex;align-items:center;gap:10px;justify-content:flex-end}
  </style>
</head>
<body>
<header>
  <h1>ü©∫ AuroraCare ‚Äî Purpose-based Medical Data Exchange</h1>
</header>
<main>
  <section id="request">
    <div class="split">
      <h2>Request</h2>
      <div class="btnrow">
        <button id="btn-eval">Evaluate Request</button>
        <button class="ghost" id="btn-copy">Copy result JSON</button>
      </div>
    </div>
    <div class="grid grid-2">
      <div class="grid">
        <div class="grid grid-2">
          <div>
            <div class="small">Requester ID</div>
            <input id="req-id" type="text" value="ruben" />
          </div>
          <div>
            <div class="small">Role</div>
            <select id="req-role">
              <option>CLINICIAN</option>
              <option>DATA_USER</option>
            </select>
          </div>
        </div>
        <div>
          <div class="small">Subject ID</div>
          <input id="subj-id" type="text" value="ruben" />
        </div>
      </div>
      <div>
        <div class="small">Environment</div>
        <div class="row" id="env-box"></div>
      </div>
    </div>
    <div style="height:8px"></div>
    <div class="grid grid-2">
      <div>
        <div class="small">Purpose</div>
        <div class="row" id="purpose-box"></div>
      </div>
      <div>
        <div class="small">Categories</div>
        <div class="row" id="cat-box"></div>
      </div>
    </div>
  </section>

  <section id="consent">
    <h2>Consent &amp; Care-team</h2>
    <div class="grid grid-3">
      <div>
        <div class="small">Consent (subject ‚Üí scientific research)</div>
        <div class="row">
          <label><input type="radio" name="consent" value="unset" checked /> unset</label>
          <label><input type="radio" name="consent" value="opt-in" /> opt-in</label>
          <label><input type="radio" name="consent" value="opt-out" /> opt-out</label>
        </div>
      </div>
      <div>
        <div class="small">Care-team link (requester ‚Üî subject)</div>
        <div class="row">
          <label><input type="radio" name="careteam" value="linked" checked /> linked</label>
          <label><input type="radio" name="careteam" value="unlinked" /> unlinked</label>
        </div>
      </div>
      <div>
        <div class="small">Other flags</div>
        <div class="row">
          <label title="Prohibit AI training for my data"><input id="flag-aioptout" type="checkbox"/> Opt-out of my data for AI systems training</label>
          <label title="Send annual outcomes to data subject"><input id="flag-annual" type="checkbox"/> Annual update on outcomes (Diabetes project)</label>
          <label title="Dataset is anonymised for research"><input id="flag-anon" type="checkbox"/> Anonymised dataset (for research/secondary use)</label>
        </div>
      </div>
    </div>
  </section>

  <section id="scenarios">
    <div class="split">
      <h2>Scenarios</h2>
      <div class="right small"></div>
    </div>
    <div class="row">
      <button class="ghost pill" data-s="A">A: Primary care</button>
      <button class="ghost pill" data-s="B">B: Secondary (QI, in-scope)</button>
      <button class="ghost pill" data-s="C">C: Secondary (QI, out-of-scope)</button>
      <button class="ghost pill" data-s="D">D: Prohibited (insurance)</button>
      <button class="ghost pill" data-s="E">E: GP checks latest labs</button>
      <button class="ghost pill" data-s="F">F: Researcher (anonymised EHRs)</button>
      <button class="ghost pill" data-s="G">G: AI training (opt-out)</button>
    </div>
  </section>

  <section id="decision">
    <h2>Decision</h2>
    <div class="kvs">
      <div class="muted">Answer</div>
      <div id="ans">‚Äî</div>
      <div class="muted">Reason why</div>
      <div id="why">Policies are ready. Click <em>Evaluate Request</em>.</div>
      <div class="muted">Check</div>
      <div id="check">‚Äî</div>
    </div>
  </section>

  <section id="policies">
    <h2>Policies (declarative JSON rules)</h2>
    <pre class="mono" id="policies-json" style="white-space:pre-wrap; overflow-wrap:anywhere; word-break:break-word; overflow-x:hidden; overflow-y:auto"></pre>
    <h3>Machine Trace (debug)</h3>
    <div class="log mono" id="trace"></div>
  </section>

  <section id="timeline">
    <h2>Timeline</h2>
    <div class="timeline" id="timeline-items">
      <div class="card muted">Recent interactions and decisions will appear here.</div>
    </div>
  </section>

  <section id="insights">
    <h2>Insights</h2>
    <div class="row" style="flex-direction:column">
      <div class="card"><div class="muted small">Primary care decisions</div><div id="ins-pc" class="mono">0</div></div>
      <div class="card"><div class="muted small">Research decisions</div><div id="ins-rs" class="mono">0</div></div>
      <div class="card"><div class="muted small">Prohibitions triggered</div><div id="ins-pr" class="mono">0</div></div>
    </div>
  </section>
</main>

<script>
/* Error surfacing */
window.onerror = function(msg, src, line, col, err){
  var t = document.getElementById('trace');
  if(t){ t.textContent = 'JS error: ' + msg + ' @ ' + line + ':' + col + (err && err.stack ? '\n' + err.stack : ''); }
};

/*** ARC-style rules (pure JSON) ***/
var ARC_RULES = [
  { id:"R-Scope-From-SecureEnv",
    if:[ {"pred":"purpose","s":"Req","o":"healthcare-quality-safety"},
         {"pred":"environment","s":"Req","o":"secure_env"} ],
    then:[ {"pred":"scope","s":"Req","o":"in-scope"} ],
    explain:"QI in secure_env implies scope in-scope"
  },
  { id:"A-Primary-Api",
    if:[ {"pred":"purpose","s":"Req","o":"primary-care"},
         {"pred":"environment","s":"Req","o":"api_gateway"},
         {"pred":"careTeamLinked","s":"Req","o":true} ],
    then:[ {"pred":"permit","s":"Req","o":"EHR"} ],
    explain:"Primary care via API gateway with linked care-team permits EHR"
  },
  { id:"A-Primary-Secure",
    if:[ {"pred":"purpose","s":"Req","o":"primary-care"},
         {"pred":"environment","s":"Req","o":"secure_env"},
         {"pred":"careTeamLinked","s":"Req","o":true} ],
    then:[ {"pred":"permit","s":"Req","o":"EHR"} ],
    explain:"Primary care in secure environment with linked care-team permits EHR"
  },
  { id:"A-Remote-Api",
    if:[ {"pred":"purpose","s":"Req","o":"remote-consult"},
         {"pred":"environment","s":"Req","o":"api_gateway"},
         {"pred":"careTeamLinked","s":"Req","o":true} ],
    then:[ {"pred":"permit","s":"Req","o":"EHR"} ],
    explain:"Remote consult via API gateway with linked care-team permits EHR"
  },
  { id:"A-Remote-Secure",
    if:[ {"pred":"purpose","s":"Req","o":"remote-consult"},
         {"pred":"environment","s":"Req","o":"secure_env"},
         {"pred":"careTeamLinked","s":"Req","o":true} ],
    then:[ {"pred":"permit","s":"Req","o":"EHR"} ],
    explain:"Remote consult in secure environment with linked care-team permits EHR"
  },
  { id:"B-QI-Allow",
    if:[ {"pred":"purpose","s":"Req","o":"healthcare-quality-safety"},
         {"pred":"scope","s":"Req","o":"in-scope"},
         {"pred":"environment","s":"Req","o":"secure_env"} ],
    then:[ {"pred":"permit","s":"Req","o":"EHR"},
           {"pred":"duty","s":"Req","o":"requireConsent"},
           {"pred":"duty","s":"Req","o":"noExfiltration"},
           {"pred":"duty","s":"Req","o":"anonymise"},
           {"pred":"policyUid","s":"Req","o":"urn:policy:qi-2025-aurora"} ],
    explain:"QI in-scope within secure_env permits EHR with duties and policy UID"
  },
  { id:"C-QI-OutOfScope",
    if:[ {"pred":"purpose","s":"Req","o":"healthcare-quality-safety"},
         {"pred":"scope","s":"Req","o":"out-of-scope"} ],
    then:[ {"pred":"forbid","s":"Req","o":"EHR"} ],
    explain:"QI out-of-scope forbids EHR"
  },
  { id:"D-Insurance-Forbidden",
    if:[ {"pred":"purpose","s":"Req","o":"insurance-management"} ],
    then:[ {"pred":"forbid","s":"Req","o":"EHR"} ],
    explain:"Insurance management purpose forbids EHR"
  },
  { id:"F-Research-Allow",
    if:[ {"pred":"purpose","s":"Req","o":"scientific-research"},
         {"pred":"consentResearch","s":"Req","o":"opt-in"} ],
    then:[ {"pred":"permit","s":"Req","o":"EHR"},
           {"pred":"duty","s":"Req","o":"anonymise"},
           {"pred":"duty","s":"Req","o":"report[P1Y]"} ],
    explain:"Scientific research with opt-in permits EHR with anonymise + annual report duties"
  },
  { id:"G-AI-Training-OptOut",
    if:[ {"pred":"purpose","s":"Req","o":"ai-systems-training"},
         {"pred":"aiTrainingOptOut","s":"Req","o":true} ],
    then:[ {"pred":"forbid","s":"Req","o":"EHR"} ],
    explain:"AI-systems training is forbidden when data subject opted out"
  },
  { id:"E-Labs-Guard",
    if:[ {"pred":"purpose","s":"Req","o":"primary-care"},
         {"pred":"hasCategory","s":"Req","o":"laboratory-results"},
         {"pred":"careTeamLinked","s":"Req","o":true} ],
    then:[ {"pred":"permit","s":"Req","o":"LatestLabs"} ],
    explain:"Primary care with labs category and linked care-team permits LatestLabs"
  },
  { id:"F-Research-AnonymisedEHRs",
    if:[ {"pred":"purpose","s":"Req","o":"scientific-research"},
         {"pred":"datasetAnonymised","s":"Req","o":true} ],
    then:[ {"pred":"permit","s":"Req","o":"AnonymisedEHRs"},
           {"pred":"duty","s":"Req","o":"anonymise"} ],
    explain:"Anonymised dataset allows research on AnonymisedEHRs"
  }
];

/*** UI lists ***/
var PURPOSES=[ {id:'primary-care',label:'primary-care (DPV-Health)'}, {id:'remote-consult',label:'remote-consult (DPV-Health)'},
  {id:'healthcare-quality-safety',label:'healthcare quality & safety (QI)'}, {id:'scientific-research',label:'healthcare scientific research'},
  {id:'ai-systems-training',label:'AI systems training'}, {id:'insurance-management',label:'insurance management (prohibition)'} ];
var ENVS=[ {id:'api_gateway',label:'api_gateway'}, {id:'secure_env',label:'secure_env'} ];
var CATS=[ {id:'laboratory-results',label:'laboratory-results'} ];

/*** Helpers ***/
function $(s){return document.querySelector(s);} function $all(s){return Array.prototype.slice.call(document.querySelectorAll(s));}
function el(tag,attrs,children){attrs=attrs||{};children=children||[];var n=document.createElement(tag);for(var k in attrs){if(!attrs.hasOwnProperty(k))continue;var v=attrs[k];
  if(k==='class'){n.className=v;} else if(k==='html'){n.innerHTML=v;} else if(k.indexOf('on')===0){n.addEventListener(k.slice(2),v);} else {n.setAttribute(k,v);} }
  for(var i=0;i<children.length;i++){n.append(children[i]);} return n;}
function renderChips(list,target,type,name){type=type||'radio';var box=$(target);box.innerHTML='';for(var i=0;i<list.length;i++){var it=list[i];var id=name+'-'+it.id;
  var input=el('input',{type:type,name:name,value:it.id,id:id}); if(type==='radio'&&i===0) input.checked=true; var lab=el('label',{},[input,document.createTextNode(' '+it.label)]); box.append(lab);} }
function renderCheckboxes(list,target){var box=$(target);box.innerHTML='';for(var i=0;i<list.length;i++){var it=list[i];var id='chk-'+it.id;var input=el('input',{type:'checkbox',value:it.id,id:id});
  var lab=el('label',{},[input,document.createTextNode(' '+it.label)]); box.append(lab);}}

/*** ARC forward chainer ***/
function isVar(x){ return typeof x==='string' && x[0]==='?'; }
function subst(term, theta){ var t={pred:term.pred,s:term.s,o:term.o}; if(isVar(t.s)&&theta[t.s]!==undefined)t.s=theta[t.s]; if(isVar(t.o)&&theta[t.o]!==undefined)t.o=theta[t.o]; return t; }
function unifyAtom(pattern, fact, theta){
  if(pattern.pred!==fact.pred) return null;
  var s=Object.assign({},theta||{});
  function bind(pv,fv){ if(isVar(pv)){ if(s[pv]===undefined){ s[pv]=fv; return true; } return s[pv]===fv; } return pv===fv; }
  if(!bind(pattern.s,fact.s)) return null; if(!bind(pattern.o,fact.o)) return null; return s;
}
function matchBody(body, facts){
  function extend(i, theta, acc){
    if(i===body.length){ acc.push(theta); return; }
    var atom=body[i];
    if(atom.not){ // negation-as-failure
      var any=false; for(var k=0;k<facts.length;k++){ if(unifyAtom(atom,facts[k],theta)){ any=true; break; } }
      if(!any) extend(i+1, theta, acc); return;
    }
    for(var k=0;k<facts.length;k++){ var t2=unifyAtom(atom,facts[k],theta); if(t2) extend(i+1,t2,acc); }
  }
  var out=[]; extend(0,{},out); return out;
}
function factKey(f){ return f.pred+'|'+JSON.stringify(f.s)+'|'+JSON.stringify(f.o); }
function containsFact(facts,f){ var key=factKey(f); for(var i=0;i<facts.length;i++){ if(factKey(facts[i])===key) return true; } return false; }
function derive(facts, rules){
  var added=true, trace=[];
  while(added){
    added=false;
    for(var r=0;r<rules.length;r++){
      var rule=rules[r];
      var thetas=matchBody(rule.if,facts);
      for(var t=0;t<thetas.length;t++){
        for(var j=0;j<rule.then.length;j++){
          var f=subst(rule.then[j],thetas[t]);
          if(!containsFact(facts,f)){ facts.push(f); trace.push('['+rule.id+'] '+JSON.stringify(f)); added=true; }
        }
      }
    }
  }
  return {facts:facts, trace:trace};
}

/*** Build input facts ***/
function factsFromRequest(req){
  var F=[]; function add(pred,s,o){ F.push({pred:pred,s:s,o:o}); }
  add('purpose','Req', req.purpose);
  add('environment','Req', req.environment[0] || null);
  add('careTeamLinked','Req', req.careteam === 'linked');
  add('consentResearch','Req', req.consent);
  add('aiTrainingOptOut','Req', !!req.flags.aioptout);
  add('datasetAnonymised','Req', !!req.flags.anon);
  if(req.qiScope) add('scope','Req', req.qiScope);
  (req.categories||[]).forEach(function(c){ add('hasCategory','Req', c); });
  return F;
}

/*** Decide from facts ***/
function decide(req, facts){
  var target=req.target;
  var permitted=facts.some(function(f){ return f.pred==='permit' && f.o===target; });
  var forbidden=facts.some(function(f){ return f.pred==='forbid' && f.o===target; });

  var answer, reason;
  if(forbidden){ answer='Denied'; reason='Prohibited by policy-derived prohibition.'; }
  else if(permitted){ answer='Allowed'; reason=(req.purpose==='healthcare-quality-safety')?'Permitted: ODRL/DPV-like rule matched for secondary use.':'Permitted by policy rule.'; }
  else { answer='Denied'; reason='No matching permission for the provided purpose and context.'; }

  var lines=[];
  lines.push(forbidden ? 'C1_prohibited_denied ‚õî DENY ‚Äì prohibition fact present'
                       : 'C1_prohibited_denied ‚è≠Ô∏è SKIPPED ‚Äì no prohibition fact');
  if(req.purpose==='primary-care') lines.push('C2_primary_role ' + (req.requester.role==='CLINICIAN' ? '‚úÖ OK ‚Äì clinician role' : '‚õî DENY ‚Äì requires CLINICIAN'));
  else lines.push('C2_primary_role ‚è≠Ô∏è SKIPPED');

  if(req.purpose==='primary-care' || req.purpose==='remote-consult')
    lines.push('C3_primary_careteam ' + (req.careteam==='linked' ? '‚úÖ OK ‚Äì linked' : '‚õî DENY ‚Äì care-team link required'));
  else lines.push('C3_primary_careteam ‚è≠Ô∏è SKIPPED');

  if(req.purpose==='healthcare-quality-safety'){
    var hasPermitEHR=facts.some(function(f){ return f.pred==='permit' && f.o==='EHR'; });
    lines.push('C4_secondary_optin_and_policy ' + ((req.consent==='opt-in' && hasPermitEHR) ? '‚úÖ OK ‚Äì opt-in present and rule matched' :
                 (req.consent!=='opt-in' ? '‚õî DENY ‚Äì opt-in required' : '‚õî DENY ‚Äì rule not matched')));
  } else lines.push('C4_secondary_optin_and_policy ‚è≠Ô∏è SKIPPED');

  if(target==='LatestLabs'){
    var hasLab=req.categories.indexOf('laboratory-results')>=0;
    lines.push('C5_category_scope ' + (hasLab ? '‚úÖ OK' : '‚õî DENY') + ' ‚Äì operator=isAllOf, allowed=["laboratory-results"], requested=' + JSON.stringify(req.categories||[]));
  } else lines.push('C5_category_scope ‚è≠Ô∏è SKIPPED');

  lines.push('C6_prohibition_blocks ' + (forbidden ? '‚õî DENY ‚Äì prohibition matched' : '‚è≠Ô∏è SKIPPED ‚Äì no prohibition matched'));
  lines.push('C7_trace_consistency ' + ((permitted||forbidden) ? '‚úÖ OK ‚Äì trace shows derived decision facts' : '‚úÖ OK ‚Äì trace shows no decision facts'));

  var duties=facts.filter(function(f){return f.pred==='duty';}).map(function(f){return f.o;});
  lines.push('C8_duties_present ' + (duties.length ? '‚ÑπÔ∏è INFO ‚Äì duties attached: ' + duties.join(', ') : '‚ÑπÔ∏è INFO ‚Äì no duties attached'));

  if(req.purpose==='healthcare-quality-safety')
    lines.push('C9_environment_scope ' + ((req.environment[0]==='secure_env') ? '‚úÖ OK' : '‚õî DENY') + ' ‚Äì operator=eq, allowed="secure_env", requested="' + (req.environment[0]||'-') + '"');
  else lines.push('C9_environment_scope ‚è≠Ô∏è SKIPPED');

  var uidFact=facts.find(function(f){return f.pred==='policyUid';});
  lines.push('C10_policy_uid ' + (uidFact ? ('‚ÑπÔ∏è INFO ‚Äì matched policy: ' + uidFact.o) : '‚ÑπÔ∏è INFO ‚Äì no policy UID'));

  return { answer:answer, reason:reason, checks:lines };
}

/*** Pretty-printer: inline "if"/"then" arrays (readable per line) ***/
function formatInlineObject(o){
  // Friendly key order (pred, s, o, not)
  var order = ["pred","s","o","not"];
  var keys = Object.keys(o).sort(function(a,b){
    var ai = order.indexOf(a), bi = order.indexOf(b);
    if (ai === -1 && bi === -1) return a < b ? -1 : a > b ? 1 : 0;
    if (ai === -1) return 1;
    if (bi === -1) return -1;
    return ai - bi;
  });
  var parts = keys.map(function(k){
    var v = o[k];
    var vs = (typeof v === 'string') ? JSON.stringify(v)
           : (typeof v === 'boolean') ? String(v)
           : JSON.stringify(v);
    return JSON.stringify(k) + ':' + vs;
  });
  return '{' + parts.join(',') + '}';
}
function formatRules(rules){
  var out = ['['];
  for (var i=0; i<rules.length; i++){
    var r = rules[i];
    out.push('  {');
    out.push('    "id": ' + JSON.stringify(r.id) + ',');
    out.push('    "if": [ ' + (r.if||[]).map(formatInlineObject).join(', ') + ' ],');
    var thenLine = '    "then": [ ' + (r.then||[]).map(formatInlineObject).join(', ') + ' ]';
    if (r.explain !== undefined) thenLine += ',';
    out.push(thenLine);
    if (r.explain !== undefined) out.push('    "explain": ' + JSON.stringify(r.explain));
    out.push('  }' + (i < rules.length-1 ? ',' : ''));
  }
  out.push(']');
  return out.join('\n');
}

/*** Scenarios ***/
var Scenarios={
  A:{target:'EHR',purpose:'primary-care',env:'api_gateway',cats:[],careteam:'linked',consent:'unset',flags:{}},
  B:{target:'EHR',purpose:'healthcare-quality-safety',env:'secure_env',cats:[],careteam:'linked',consent:'opt-in',flags:{},qiScope:'in-scope'},
  C:{target:'EHR',purpose:'healthcare-quality-safety',env:'secure_env',cats:[],careteam:'linked',consent:'unset',flags:{},qiScope:'out-of-scope'},
  D:{target:'EHR',purpose:'insurance-management',env:'api_gateway',cats:[],careteam:'linked',consent:'unset',flags:{}},
  E:{target:'LatestLabs',purpose:'primary-care',env:'api_gateway',cats:['laboratory-results'],careteam:'linked',consent:'unset',flags:{}},
  F:{target:'AnonymisedEHRs',purpose:'scientific-research',env:'secure_env',cats:[],careteam:'unlinked',consent:'opt-in',flags:{anon:true,annual:true}},
  G:{target:'EHR',purpose:'ai-systems-training',env:'secure_env',cats:[],careteam:'unlinked',consent:'unset',flags:{aioptout:true}}
};

/*** App wiring ***/
function boot(){
  renderChips(PURPOSES,'#purpose-box','radio','purpose');
  renderChips(ENVS,'#env-box','radio','env');
  renderCheckboxes(CATS,'#cat-box');

  // Policies printout in readable per-line style with inline arrays
  document.getElementById('policies-json').textContent = formatRules(ARC_RULES);

  // Buttons
  $all('#scenarios button').forEach(function(btn){ btn.addEventListener('click', function(){ applyScenario(btn.getAttribute('data-s')); }); });
  document.getElementById('btn-eval').addEventListener('click', doEvaluate);
  document.getElementById('btn-copy').addEventListener('click', copyResult);
}
function currentRequest(){
  var purpose=document.querySelector('input[name="purpose"]:checked').value;
  var envSel=document.querySelector('input[name="env"]:checked');
  var environment=envSel?[envSel.value]:[];
  var categories=$all('#cat-box input:checked').map(function(i){return i.value;});
  var consent=document.querySelector('input[name="consent"]:checked').value;
  var careteam=document.querySelector('input[name="careteam"]:checked').value;
  var flags={ aioptout:document.getElementById('flag-aioptout').checked, annual:document.getElementById('flag-annual').checked, anon:document.getElementById('flag-anon').checked };
  var qiScope=(purpose==='healthcare-quality-safety') ? (window.__qiScopeOverride || ((environment[0]==='secure_env') ? 'in-scope' : null)) : null;
  var target=inferTarget(purpose,categories,flags);
  return { requester:{id:document.getElementById('req-id').value.trim(), role:document.getElementById('req-role').value},
           subject:{id:document.getElementById('subj-id').value.trim()}, target:target, purpose:purpose, environment:environment,
           categories:categories, consent:consent, careteam:careteam, flags:flags, qiScope:qiScope };
}
function inferTarget(purpose,cats,flags){ if(purpose==='scientific-research' && flags.anon) return 'AnonymisedEHRs'; if(cats.indexOf('laboratory-results')>=0) return 'LatestLabs'; return 'EHR'; }
function doEvaluate(){
  var req=currentRequest();
  var facts=factsFromRequest(req);
  if(req.qiScope) facts.push({pred:'scope',s:'Req',o:req.qiScope});
  var closure=derive(facts.slice(), ARC_RULES);
  var dec=decide(req, closure.facts);
  document.getElementById('ans').innerHTML=(dec.answer==='Allowed'?'<strong class="ok">‚úÖ Allowed</strong>':'<strong class="no">‚õî Denied</strong>');
  document.getElementById('why').textContent=dec.reason;
  document.getElementById('check').innerHTML=dec.checks.map(function(s){return '<div>‚Ä¢ '+s+'</div>';}).join('');
  document.getElementById('trace').textContent=closure.trace.join('\n');
  pushTimeline(req,{answer:dec.answer,reason:dec.reason}); bumpInsights(req,{answer:dec.answer});
  window.__lastResult={ request:req, facts:facts, derived:closure.facts, trace:closure.trace, decision:dec, ts:(new Date()).toISOString() };
}
function applyScenario(key){
  var s=Scenarios[key]; if(!s) return;
  document.querySelector('input[name="purpose"][value="'+s.purpose+'"]').checked=true;
  document.querySelector('input[name="env"][value="'+s.env+'"]').checked=true;
  $all('#cat-box input').forEach(function(i){ i.checked = s.cats.indexOf(i.value) >= 0; });
  document.querySelector('input[name="consent"][value="'+s.consent+'"]').checked=true;
  document.querySelector('input[name="careteam"][value="'+s.careteam+'"]').checked=true;
  document.getElementById('flag-aioptout').checked=!!s.flags.aioptout;
  document.getElementById('flag-annual').checked=!!s.flags.annual;
  document.getElementById('flag-anon').checked=!!s.flags.anon;
  window.__qiScopeOverride=s.qiScope||null;
  doEvaluate();
}
function pushTimeline(req,res){
  var box=document.getElementById('timeline-items');
  var card=el('div',{class:'card'});
  var when=(new Date()).toLocaleString();
  card.innerHTML='<div class="row" style="justify-content:space-between"><strong>'+(res.answer==='Allowed'?'‚úÖ Allowed':'‚õî Denied')+'</strong><span class="muted small">'+when+'</span></div>'+
                 '<div class="small muted">purpose=<span class="mono">'+req.purpose+'</span> ‚Ä¢ env=<span class="mono">'+(req.environment[0]||'-')+'</span> ‚Ä¢ target=<span class="mono">'+req.target+'</span></div>'+
                 '<div class="small">'+res.reason+'</div>';
  box.prepend(card);
}
var InsightCounters={pc:0,rs:0,pr:0};
function bumpInsights(req,res){ if(req.purpose==='primary-care') InsightCounters.pc++; if(req.purpose==='scientific-research') InsightCounters.rs++; if(res.answer==='Denied') InsightCounters.pr++;
  document.getElementById('ins-pc').textContent=InsightCounters.pc; document.getElementById('ins-rs').textContent=InsightCounters.rs; document.getElementById('ins-pr').textContent=InsightCounters.pr; }
function copyResult(){ try{ var payload=JSON.stringify(window.__lastResult||{error:'no-result'},null,2); navigator.clipboard.writeText(payload);
  var b=document.getElementById('btn-copy'); var old=b.textContent; b.textContent='Copied!'; setTimeout(function(){ b.textContent=old; }, 1000); }catch(e){ alert('Copy failed: '+e.message); } }

/* Boot */
window.addEventListener('DOMContentLoaded', function(){ try{ boot(); }catch(e){ var t=document.getElementById('trace'); if(t) t.textContent='Boot error: ' + (e && e.stack || e); } });
if(document.readyState!=='loading'){ try{ boot(); }catch(e){ var t=document.getElementById('trace'); if(t) t.textContent='Boot error: ' + (e && e.stack || e); } }
</script>
</body>
</html>

