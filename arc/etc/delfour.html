<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Delfour — JS logic + Turtle data/ODRL</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{ --muted:#64748b; --ink:#0f172a; --line:#e2e8f0; --bg:#f8fafc; --accent:#4f46e5; --ok:#059669; --bad:#dc2626; }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:16px;color:var(--ink)}
    h1{margin:0 0 6px;font-size:20px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:8px;align-items:center;margin:10px 0;flex-wrap:wrap}
    .btn{padding:8px 12px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .step{display:inline-flex;align-items:center;justify-content:center;width:26px;height:26px;border-radius:999px;background:#eef2ff;color:#3730a3;font-weight:600;font-size:13px;border:1px solid #e0e7ff;margin-right:6px}
    .trail{font-size:12px;color:var(--muted)}
    .card{border:1px solid var(--line);border-radius:14px;padding:10px;background:#fff;margin-top:10px}
    .card h3{margin:0 0 6px;font-size:14px;color:#111827;display:flex;align-items:center;gap:8px}
    .file{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:11px;background:#eef2ff;border:1px solid #e0e7ff;color:#3730a3;border-radius:999px;padding:1px 8px}
    .tag{font-size:11px;border:1px solid var(--line);background:#fff;border-radius:999px;padding:1px 8px;color:#334155}
    pre{white-space:pre-wrap;word-break:break-word;background:var(--bg);border:1px solid var(--line);border-radius:8px;padding:8px;font-size:12px;max-height:280px;overflow:auto}
    .timeline{list-style:none;padding-left:0;margin:0}
    .timeline li{display:flex;gap:8px;align-items:flex-start;padding:4px 0;border-bottom:1px dashed #e5e7eb}
    .ts{color:#94a3b8;min-width:86px}
    .ev{font-weight:600;min-width:120px}
    .badge{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:999px;font-size:12px;margin-right:6px}
    .ok{background:#dcfce7;color:#065f46}
    .bad{background:#fee2e2;color:#991b1b}
  </style>
</head>
<body>
  <h1>Delfour — JS logic + Turtle</h1>
  <div class="muted">A privacy-first, client-side demo that turns POD profile + session context into a neutral Insight with ODRL policy, then authorizes and (if needed) suggests a lower-sugar alternative. All logic in JavaScript; data & policies in Turtle.</div>

  <div class="row">
    <button id="runBtn" class="btn primary">Run Demo</button>
    <label class="muted">Session&nbsp;<input id="sessionId" value="S1" style="padding:6px;border:1px solid #cbd5e1;border-radius:8px"></label>
    <span id="status" class="muted"></span>
  </div>

  <!-- Step 1: PHONE inputs -->
  <div class="card">
    <h3><span class="step">1</span><b>PHONE — Inputs</b> <span class="trail">profile.ttl + context.ttl</span></h3>
    <div class="card"><h3><span class="file">profile.ttl</span> <span class="tag">POD data</span></h3><pre id="profileBox"></pre></div>
    <div class="card"><h3><span class="file">context.ttl</span> <span class="tag">session</span></h3><pre id="contextBox"></pre></div>
  </div>

  <!-- Step 2: PHONE derived -->
  <div class="card">
    <h3><span class="step">2</span><b>PHONE — Derived</b> <span class="trail">JS ⇒ insight.ttl + policy.ttl</span></h3>
    <div class="card"><h3><span class="file">insight.ttl</span> <span class="tag">derived</span></h3><pre id="insightBox"></pre></div>
    <div class="card"><h3><span class="file">policy.ttl</span> <span class="tag">derived</span></h3><pre id="policyBox"></pre></div>
  </div>

  <!-- Step 3: SCANNER inputs -->
  <div class="card">
    <h3><span class="step">3</span><b>SCANNER — Inputs</b> <span class="trail">now.ttl + request.ttl + catalog.ttl + scan.ttl</span></h3>
    <div class="card"><h3><span class="file">now.ttl</span> <span class="tag">clock</span></h3><pre id="nowBox"></pre></div>
    <div class="card"><h3><span class="file">request.ttl</span> <span class="tag">use@shopping_assist</span></h3><pre id="requestBox"></pre></div>
    <div class="card"><h3><span class="file">catalog.ttl</span> <span class="tag">products</span></h3><pre id="catalogBox"></pre></div>
    <div class="card"><h3><span class="file">scan.ttl</span> <span class="tag">event</span></h3><pre id="scanBox"></pre></div>
  </div>

  <!-- Step 4: SCANNER derived + Step 5: Summary -->
  <div class="card">
    <h3><span class="step">4</span><b>SCANNER — Derived</b> <span class="trail">JS ⇒ audit.ttl + banner.json</span></h3>
    <div class="card"><h3><span class="file">audit.ttl</span> <span class="tag">derived</span></h3><pre id="auditBox"></pre></div>
    <div class="card"><h3><span class="file">banner.json</span> <span class="tag">runtime preview</span></h3><pre id="bannerBox"></pre></div>
  </div>

  <div class="card">
    <h3><span class="step">5</span><b>Summary & Harness</b> <span class="trail">Decision • Suggestion • Checks • Reason • Timeline</span></h3>
    <div class="card"><h3><span class="file">summary.json</span></h3><pre id="summaryBox"></pre></div>
    <div class="card"><h3><span class="file">checks.txt</span></h3><ul id="checksBox" class="timeline"></ul></div>
    <div class="card"><h3><span class="file">reason.txt</span></h3><pre id="reasonBox"></pre></div>
    <div class="card"><h3><span class="file">timeline.txt</span></h3><ul id="timelineBox" class="timeline"></ul></div>
  </div>

<script type="module">
/* ---------------- UI helpers ---------------- */
const $ = (id)=>document.getElementById(id);
const setStatus = (s)=>{ $('status').textContent = s||''; };
const addTimeline = (ev, detail="")=>{
  const li = document.createElement('li');
  const ts = new Date().toISOString().split('T')[1].replace('Z','');
  li.innerHTML = `<span class="ts">${ts}</span><span class="ev">${ev}</span><span>${detail}</span>`;
  $('timelineBox').appendChild(li);
};
const showChecks = (pairs)=>{
  const box = $('checksBox'); box.innerHTML = '';
  pairs.forEach(([name, ok])=>{
    const li = document.createElement('li');
    const badge = `<span class="badge ${ok?'ok':'bad'}">${ok?'✓':'✗'}</span>`;
    li.innerHTML = `<span class="ts"></span><span class="ev">${badge}${name}</span>`;
    box.appendChild(li);
  });
};
const REASON = "Household requires low-sugar guidance (diabetes in POD). Neutral insight scoped to device+event+retailer; expires soon.";

/* ---------------- TTL input builders (data in Turtle) ---------------- */
const profileTTL = `@prefix :       <https://example.org/person#> .
@prefix health: <https://example.org/health#> .
:me  health:householdCondition  health:Diabetes .`;

const contextTTL = ({created, expires}) => `@prefix ctx: <https://example.org/context#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
[] ctx:retailer "Delfour" ;
   ctx:device   "self-scanner" ;
   ctx:event    "pick_up_scanner" ;
   ctx:createdAt "${created}"^^xsd:dateTime ;
   ctx:expiresAt "${expires}"^^xsd:dateTime .`;

const nowTTL = (nowISO) => `@prefix ex:  <https://example.org/enforce#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
[] ex:now "${nowISO}"^^xsd:dateTime .`;

const requestTTL = `@prefix odrl: <http://www.w3.org/ns/odrl/2/> .
@prefix req:  <https://example.org/request#> .
req:r1 odrl:action odrl:use ;
      odrl:constraint [
        odrl:leftOperand  odrl:purpose ;
        odrl:rightOperand "shopping_assist"
      ] .`;

const catalogTTL = `@prefix prod:   <https://example.org/product#> .
@prefix schema: <http://schema.org/> .
@prefix xsd:    <http://www.w3.org/2001/XMLSchema#> .
prod:BIS_001 a schema:Product ; schema:name "Classic Tea Biscuits" ; schema:sugarContent "12.0"^^xsd:decimal .
prod:BIS_101 a schema:Product ; schema:name "Low-Sugar Tea Biscuits" ; schema:sugarContent "3.0"^^xsd:decimal .
prod:CHOC_050 a schema:Product ; schema:name "Milk Chocolate Bar"   ; schema:sugarContent "15.0"^^xsd:decimal .
prod:CHOC_150 a schema:Product ; schema:name "85% Dark Chocolate"   ; schema:sugarContent "6.0"^^xsd:decimal .`;

const scanTTL = `@prefix shop: <https://example.org/shop#> .
@prefix prod: <https://example.org/product#> .
[] shop:scannedProduct prod:BIS_001 .`;

/* ---------------- Minimal TTL parsing helpers (controlled data) ---------------- */
const pick = (ttl, re, def=null)=> (ttl.match(re)||[])[1] ?? def;
const parseContext = (ttl)=> ({
  retailer:    pick(ttl, /ctx:retailer\s+"([^"]+)"/),
  device:      pick(ttl, /ctx:device\s+"([^"]+)"/),
  event:       pick(ttl, /ctx:event\s+"([^"]+)"/),
  createdAt:   pick(ttl, /ctx:createdAt\s+"([^"]+)"/),
  expiresAt:   pick(ttl, /ctx:expiresAt\s+"([^"]+)"/),
});
const parseNow = (ttl)=> pick(ttl, /ex:now\s+"([^"]+)"/);
const parseScan = (ttl)=> pick(ttl, /shop:scannedProduct\s+([^\s]+)\s*\./);
function parseCatalog(ttl){
  const lines = ttl.split(/\n/);
  const items = {};
  for(const ln of lines){
    const m = ln.match(/^(prod:[A-Z_0-9]+).+schema:name\s+"([^"]+)".+schema:sugarContent\s+"([\d.]+)"/);
    if(m){ items[m[1]] = { name:m[2], sugar: parseFloat(m[3]) }; }
  }
  return items;
}

/* ---------------- JS “rules” implemented imperatively ---------------- */
// Derive neutral Insight from profile+context (desensitization is assumed)
function deriveInsight({context}){
  const id = `https://example.org/insight/${crypto.randomUUID?.()||Date.now()}`;
  const thr = 10.0;
  const ttl = `@prefix ins: <https://example.org/insight#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
<${id}> a ins:Insight ;
  ins:metric "sugar_g_per_serving" ;
  ins:threshold "${thr.toFixed(1)}"^^xsd:decimal ;
  ins:suggestionPolicy "lower_metric_first_higher_price_ok" ;
  ins:scopeDevice "${context.device}" ;
  ins:scopeEvent "${context.event}" ;
  ins:retailer "${context.retailer}" ;
  ins:createdAt "${context.createdAt}"^^xsd:dateTime ;
  ins:expiresAt "${context.expiresAt}"^^xsd:dateTime .`;
  return { id, threshold: thr, insightTTL: ttl };
}

// Build ODRL policy Turtle from the Insight (typed expiry)
function buildPolicy({insightId, expiresAt}){
  return `@prefix odrl: <http://www.w3.org/ns/odrl/2/> .
@prefix ins:  <https://example.org/insight#> .
@prefix xsd:  <http://www.w3.org/2001/XMLSchema#> .
_:pol a odrl:Policy ;
  odrl:profile "Delfour-Insight-Policy" ;
  odrl:permission [
    odrl:action odrl:use ;
    odrl:target <${insightId}> ;
    odrl:constraint [
      odrl:leftOperand odrl:purpose ;
      odrl:operator    odrl:eq ;
      odrl:rightOperand "shopping_assist"
    ]
  ] ;
  odrl:prohibition [
    odrl:action odrl:share ;
    odrl:target <${insightId}> ;
    odrl:constraint [
      odrl:leftOperand odrl:purpose ;
      odrl:operator    odrl:eq ;
      odrl:rightOperand "marketing"
    ]
  ] ;
  odrl:duty [
    odrl:action odrl:delete ;
    odrl:constraint [
      odrl:leftOperand odrl:dateTime ;
      odrl:operator    odrl:eq ;
      odrl:rightOperand "${expiresAt}"^^xsd:dateTime
    ]
  ] .`;
}

// Enforce: check purpose permission and expiry
function enforce({policyTTL, requestTTL, nowISO, insightId, expiresAt}){
  const purposeOK = /rightOperand\s+"shopping_assist"/.test(policyTTL) &&
                    /odrl:action odrl:use/.test(requestTTL);
  const expired = new Date(nowISO) > new Date(expiresAt);
  const allowed = purposeOK && !expired;
  const auditTTL = `@prefix act: <https://example.org/activity#> .
@prefix ex:  <https://example.org/enforce#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
_:dec a act:Decision ;
  act:at "${nowISO}"^^xsd:dateTime ;
  act:request <https://example.org/request/r1> ;
  act:outcome "${allowed ? "Allowed" : "Blocked"}" ${expired ? '; act:reason "expired"' : ''} .
${expired ? `<${insightId}> a ex:Expired .` : ''}`;
  return { allowed, expired, auditTTL };
}

// Shopping suggestion if allowed: pick lower sugar than scanned
function suggest({allowed, catalog, scannedQName, threshold}){
  const scanned = catalog[scannedQName];
  if(!allowed || !scanned) return { banner: {
    headline: "Policy blocked action", product_name: null, note: "Expired or prohibited", suggested_alternative: null
  }, altName: null };

  if (scanned.sugar < threshold) {
    return { banner: { headline:"Scan complete", product_name: scanned.name, note: null, suggested_alternative: null }, altName: null };
  }
  const alts = Object.values(catalog).filter(p => p.sugar < scanned.sugar);
  const best = alts.sort((a,b)=>a.sugar-b.sugar)[0];
  if (best){
    return { banner: { headline:"Track sugar per serving while you scan", product_name: scanned.name, note:"High sugar", suggested_alternative: best.name }, altName: best.name };
  }
  return { banner: { headline:"Scan complete", product_name: scanned.name, note: null, suggested_alternative: null }, altName: null };
}

/* ---------------- Orchestrator ---------------- */
function isoNow(){ return new Date().toISOString(); }
function isoPlusHours(h){ return new Date(Date.now()+h*3600*1000).toISOString(); }

document.getElementById('runBtn').addEventListener('click', () => {
  (async () => {
    const btn = document.getElementById('runBtn');
    btn.disabled = true;
    try{
      setStatus("Preparing inputs…");
      const created = isoNow();
      const expires = isoPlusHours(2);
      const now = isoNow();

      const ctxTtl = contextTTL({created, expires});
      const ctx = parseContext(ctxTtl);
      const cat = parseCatalog(catalogTTL);
      const scanned = parseScan(scanTTL);

      // Show inputs
      $('profileBox').textContent = profileTTL;
      $('contextBox').textContent = ctxTtl;
      $('nowBox').textContent = nowTTL(now);
      $('requestBox').textContent = requestTTL;
      $('catalogBox').textContent = catalogTTL;
      $('scanBox').textContent = scanTTL;

      // PHONE phase
      addTimeline("PICKUP", `scanner="${ctx.device}" retailer="${ctx.retailer}"`);
      addTimeline("AGENT-DIALOG", "capabilities received");
      setStatus("Deriving Insight + Policy…");
      const { id: insightId, threshold, insightTTL } = deriveInsight({context: ctx});
      const policyTTLStr = buildPolicy({insightId, expiresAt: ctx.expiresAt});
      $('insightBox').textContent = insightTTL;
      $('policyBox').textContent  = policyTTLStr;
      addTimeline("INSIGHT", "neutral low-sugar envelope emitted");
      addTimeline("POLICY", "ODRL policy emitted");

      // SCANNER phase
      setStatus("Authorization + Audit + Suggestion…");
      const { allowed, expired, auditTTL } = enforce({
        policyTTL: policyTTLStr, requestTTL, nowISO: now, insightId, expiresAt: ctx.expiresAt
      });
      $('auditBox').textContent = auditTTL;

      const { banner, altName } = suggest({ allowed, catalog: cat, scannedQName: scanned, threshold });
      $('bannerBox').textContent = JSON.stringify(banner, null, 2);

      addTimeline("AUTH", allowed ? "Allowed (use@shopping_assist)" : (expired ? "Blocked (expired)" : "Blocked"));
      addTimeline("RUNTIME", "banner written");
      addTimeline("DROP", "scanner returned; session closed");

      // Checks + reason
      $('reasonBox').textContent = REASON;
      const checks = [
        ["insight_nonempty", !!insightTTL.trim()],
        ["minimization_no_sensitive_terms", !/diabetes|medical/i.test(insightTTL)],
        ["scope_has_device_event_expiry", /ins:scopeDevice|ins:scopeEvent|ins:expiresAt/.test(insightTTL)],
        ["runtime_present", !!banner.headline],
        ["behavior_suggests_on_high_sugar", !!banner.note],
        ["audit_has_decision", /act:Decision/.test(auditTTL)]
      ];
      showChecks(checks);

      // Summary
      $('summaryBox').textContent = JSON.stringify({
        decision: allowed ? "Allowed" : "Blocked",
        expired, suggestedAlternative: altName
      }, null, 2);

      setStatus("Done.");
    }catch(e){
      console.error(e);
      setStatus("Error: " + (e?.message || e));
    }finally{
      btn.disabled = false;
    }
  })();
});
setStatus("Ready.");
</script>
</body>
</html>

