<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Delfour Insight Economy</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light" />
  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html, body { height: 100%; }
    pre { white-space: pre-wrap; word-break: break-word; }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  </style>
</head>
<body class="bg-gradient-to-b from-slate-50 to-white text-slate-900 min-h-screen">
  <main class="max-w-6xl mx-auto p-6">
    <header class="mb-6">
      <h1 class="text-2xl font-bold">Delfour Insight Economy</h1>
      <p class="text-slate-600">
        Reasoning powered by <span class="font-mono">eye-js</span>
      </p>
    </header>

    <!-- What this is? -->
    <section class="mb-4">
      <div class="rounded-2xl border border-gray-200 bg-white shadow-sm p-4">
        <h3 class="text-lg font-semibold mb-2">What this is?</h3>
        <p class="text-sm text-slate-700">
          Client-side demo that keeps data &amp; ODRL policy in Turtle, while logic runs in eye-js.
          It derives a neutral Insight, builds an ODRL policy, authorizes a purpose-limited request,
          and suggests a lower-sugar alternative.
        </p>
      </div>
    </section>

    <div class="flex items-center gap-3 mb-6">
      <button id="runBtn"
              class="px-4 py-2 rounded-xl bg-indigo-600 text-white font-semibold shadow hover:bg-indigo-500 disabled:opacity-50">
        Run Demo
      </button>
      <label class="text-slate-600 text-sm flex items-center gap-2">
        Session
        <input id="sessionId" value="S1" class="px-2 py-1 border border-slate-300 rounded-lg" />
      </label>
      <span id="status" class="text-sm text-slate-600"></span>
    </div>

    <!-- ONE-COLUMN FLOW -->
    <section class="space-y-4">
      <!-- 1) PHONE — Inputs -->
      <div class="rounded-2xl border border-gray-200 bg-white shadow-sm p-4">
        <h3 class="text-lg font-semibold mb-2">PHONE — Inputs <span class="text-xs text-slate-500">(profile.ttl + context.ttl)</span></h3>
        <div class="grid grid-cols-1 gap-4">
          <div>
            <div class="flex items-center gap-2 mb-1">
              <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs bg-indigo-50 text-indigo-700 border border-indigo-100">profile.ttl</span>
              <span class="text-xs text-slate-500">POD data</span>
            </div>
            <pre id="profileBox" class="text-xs"></pre>
          </div>
          <div>
            <div class="flex items-center gap-2 mb-1">
              <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs bg-indigo-50 text-indigo-700 border border-indigo-100">context.ttl</span>
              <span class="text-xs text-slate-500">session</span>
            </div>
            <pre id="contextBox" class="text-xs"></pre>
          </div>
        </div>
      </div>

      <!-- 2) PHONE — Derived -->
      <div class="rounded-2xl border border-gray-200 bg-white shadow-sm p-4">
        <h3 class="text-lg font-semibold mb-2">PHONE — Derived <span class="text-xs text-slate-500">(insight + policy)</span></h3>
        <div class="grid grid-cols-1 gap-4">
          <div>
            <div class="flex items-center gap-2 mb-1">
              <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs bg-emerald-50 text-emerald-700 border border-emerald-100">insight (derived)</span>
              <span class="text-xs text-slate-500">neutral envelope</span>
            </div>
            <pre id="insightBox" class="text-xs"></pre>
          </div>
          <div>
            <div class="flex items-center gap-2 mb-1">
              <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs bg-emerald-50 text-emerald-700 border border-emerald-100">policy (derived)</span>
              <span class="text-xs text-slate-500">ODRL</span>
            </div>
            <pre id="policyBox" class="text-xs"></pre>
          </div>
        </div>
      </div>

      <!-- 3) SCANNER — Inputs -->
      <div class="rounded-2xl border border-gray-200 bg-white shadow-sm p-4">
        <h3 class="text-lg font-semibold mb-2">SCANNER — Inputs <span class="text-xs text-slate-500">(now + request + catalog + scan)</span></h3>
        <div class="grid grid-cols-1 gap-4">
          <div>
            <div class="flex items-center gap-2 mb-1">
              <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs bg-amber-50 text-amber-700 border border-amber-100">now.ttl</span>
              <span class="text-xs text-slate-500">clock</span>
            </div>
            <pre id="nowBox" class="text-xs"></pre>
          </div>
          <div>
            <div class="flex items-center gap-2 mb-1">
              <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs bg-amber-50 text-amber-700 border border-amber-100">request.ttl</span>
              <span class="text-xs text-slate-500">use@shopping_assist</span>
            </div>
            <pre id="requestBox" class="text-xs"></pre>
          </div>
          <div>
            <div class="flex items-center gap-2 mb-1">
              <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs bg-amber-50 text-amber-700 border border-amber-100">catalog.ttl</span>
              <span class="text-xs text-slate-500">products</span>
            </div>
            <pre id="catalogBox" class="text-xs"></pre>
          </div>
          <div>
            <div class="flex items-center gap-2 mb-1">
              <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs bg-amber-50 text-amber-700 border border-amber-100">scan.ttl</span>
              <span class="text-xs text-slate-500">event</span>
            </div>
            <pre id="scanBox" class="text-xs"></pre>
          </div>
        </div>
      </div>

      <!-- 4) SCANNER — Derived + 5) Summary -->
      <div class="rounded-2xl border border-gray-200 bg-white shadow-sm p-4">
        <h3 class="text-lg font-semibold mb-2">SCANNER — Derived <span class="text-xs text-slate-500">(auth + audit + suggestion)</span></h3>
        <div class="grid grid-cols-1 gap-4">
          <div>
            <div class="flex items-center gap-2 mb-1">
              <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs bg-rose-50 text-rose-700 border border-rose-100">audit (derived)</span>
              <span class="text-xs text-slate-500">decision trail</span>
            </div>
            <pre id="auditBox" class="text-xs"></pre>
          </div>
          <div>
            <div class="flex items-center gap-2 mb-1">
              <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs bg-rose-50 text-rose-700 border border-rose-100">banner.json</span>
              <span class="text-xs text-slate-500">runtime preview</span>
            </div>
            <pre id="bannerBox" class="text-xs"></pre>
          </div>
        </div>
      </div>

      <div class="rounded-2xl border border-gray-200 bg-white shadow-sm p-4">
        <h3 class="text-lg font-semibold mb-2">Summary &amp; Harness <span class="text-xs text-slate-500">(decision • suggestion • checks • reason • timeline)</span></h3>
        <div class="grid grid-cols-1 gap-4">
          <div>
            <div class="flex items-center gap-2 mb-1">
              <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs bg-sky-50 text-sky-700 border border-sky-100">summary.json</span>
            </div>
            <pre id="summaryBox" class="text-xs"></pre>
          </div>
          <div>
            <div class="flex items-center gap-2 mb-1">
              <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs bg-sky-50 text-sky-700 border border-sky-100">checks</span>
            </div>
            <div id="checks" class="text-sm space-y-1"></div>
          </div>
          <div>
            <div class="flex items-center gap-2 mb-1">
              <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs bg-sky-50 text-sky-700 border border-sky-100">reason.txt</span>
            </div>
            <pre id="reasonBox" class="text-xs"></pre>
          </div>
          <div>
            <div class="flex items-center gap-2 mb-1">
              <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs bg-sky-50 text-sky-700 border border-sky-100">timeline</span>
            </div>
            <ul id="timeline" class="text-sm space-y-1"></ul>
          </div>
        </div>
      </div>
    </section>

    <footer class="mt-8 text-xs text-slate-500">
      Inspired by AuroraCare’s layout. Powered by <span class="font-mono">eye-js</span>.
    </footer>
  </main>

  <!-- eye-js (dynamic import) -->
  <script type="module">
    // ------- Minimal UI helpers -------
    const statusEl = document.getElementById("status");
    const runBtn   = document.getElementById("runBtn");

    function setStatus(msg){ statusEl.textContent = msg || ""; }
    function addTimeline(ev, detail=""){
      const li = document.createElement("li");
      const ts = new Date().toLocaleTimeString();
      li.className = "flex gap-2";
      li.innerHTML = `<span class="text-slate-400 w-28 shrink-0">${ts}</span>
                      <span class="font-semibold w-36 shrink-0">${ev}</span>
                      <span class="text-slate-700">${detail||""}</span>`;
      document.getElementById("timeline").appendChild(li);
    }
    function showChecks(arr){
      const box = document.getElementById("checks");
      box.innerHTML = "";
      arr.forEach(([name, ok])=>{
        const row = document.createElement("div");
        row.className = "flex items-center gap-2";
        const badge = document.createElement("span");
        badge.className = "inline-flex h-5 w-5 items-center justify-center rounded-full " + (ok ? "bg-emerald-100 text-emerald-700" : "bg-rose-100 text-rose-700");
        badge.textContent = ok ? "✓" : "✗";
        const label = document.createElement("span");
        label.textContent = name;
        row.append(badge, label);
        box.appendChild(row);
      });
    }

    // ------- Build TTL inputs -------
    const profileTTL = `@prefix :       <https://example.org/person#> .
@prefix health: <https://example.org/health#> .
:me  health:householdCondition  health:Diabetes .`;

    const contextTTL = ({created, expires}) => `@prefix ctx: <https://example.org/context#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
[] ctx:retailer "Delfour" ;
   ctx:device   "self-scanner" ;
   ctx:event    "pick_up_scanner" ;
   ctx:createdAt "${created}"^^xsd:dateTime ;
   ctx:expiresAt "${expires}"^^xsd:dateTime .`;

    const nowTTL = (nowISO) => `@prefix ex:  <https://example.org/enforce#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
[] ex:now "${nowISO}"^^xsd:dateTime .`;

    const requestTTL = `@prefix odrl: <http://www.w3.org/ns/odrl/2/> .
@prefix req:  <https://example.org/request#> .
req:r1 odrl:action odrl:use ;
      odrl:constraint [
        odrl:leftOperand  odrl:purpose ;
        odrl:rightOperand "shopping_assist"
      ] .`;

    const catalogTTL = `@prefix prod:   <https://example.org/product#> .
@prefix schema: <http://schema.org/> .
@prefix xsd:    <http://www.w3.org/2001/XMLSchema#> .
prod:BIS_001 a schema:Product ; schema:name "Classic Tea Biscuits" ; schema:sugarContent "12.0"^^xsd:decimal .
prod:BIS_101 a schema:Product ; schema:name "Low-Sugar Tea Biscuits" ; schema:sugarContent "3.0"^^xsd:decimal .
prod:CHOC_050 a schema:Product ; schema:name "Milk Chocolate Bar"   ; schema:sugarContent "15.0"^^xsd:decimal .
prod:CHOC_150 a schema:Product ; schema:name "85% Dark Chocolate"   ; schema:sugarContent "6.0"^^xsd:decimal .`;

    const scanTTL = `@prefix shop: <https://example.org/shop#> .
@prefix prod: <https://example.org/product#> .
[] shop:scannedProduct prod:BIS_001 .`;

    // ------- N3 rule sets (executed by eye-js) -------
    const PHONE_RULES = `@prefix :        <https://example.org/person#> .
@prefix health:  <https://example.org/health#> .
@prefix need:    <https://example.org/need#> .
@prefix ctx:     <https://example.org/context#> .
@prefix ins:     <https://example.org/insight#> .
@prefix odrl:    <http://www.w3.org/ns/odrl/2/> .
@prefix xsd:     <http://www.w3.org/2001/XMLSchema#> .

{ ?p health:householdCondition health:Diabetes. } => { ?p need:needsLowSugar true. } .

{
  ?p need:needsLowSugar true.
  ?c  ctx:retailer   ?ret ;
      ctx:device     ?dev ;
      ctx:event      ?ev ;
      ctx:createdAt  ?ts  ;
      ctx:expiresAt  ?exp .
}
=>
{
  _:ins a                 ins:Insight ;
        ins:metric        "sugar_g_per_serving" ;
        ins:threshold     "10.0"^^xsd:decimal ;
        ins:suggestionPolicy "lower_metric_first_higher_price_ok" ;
        ins:scopeDevice   ?dev ;
        ins:scopeEvent    ?ev ;
        ins:retailer      ?ret ;
        ins:createdAt     ?ts ;
        ins:expiresAt     ?exp .
} .

{
  ?ins a ins:Insight ;
       ins:retailer     ?ret ;
       ins:scopeDevice  ?dev ;
       ins:scopeEvent   ?ev ;
       ins:expiresAt    ?exp .
}
=>
{
  _:pol a odrl:Policy ;
        odrl:profile    "Delfour-Insight-Policy" ;

        odrl:permission [
          odrl:action      odrl:use ;
          odrl:target      ?ins ;
          odrl:constraint [
            odrl:leftOperand  odrl:purpose ;
            odrl:operator     odrl:eq ;
            odrl:rightOperand "shopping_assist"
          ]
        ] ;

        odrl:prohibition [
          odrl:action      odrl:share ;
          odrl:target      ?ins ;
          odrl:constraint [
            odrl:leftOperand  odrl:purpose ;
            odrl:operator     odrl:eq ;
            odrl:rightOperand "marketing"
          ]
        ] ;

        odrl:duty [
          odrl:action      odrl:delete ;
          odrl:constraint [
            odrl:leftOperand  odrl:dateTime ;
            odrl:operator     odrl:eq ;
            odrl:rightOperand ?exp
          ]
        ] .
} .
`;

    const SCANNER_RULES = `@prefix ins:   <https://example.org/insight#> .
@prefix odrl:  <http://www.w3.org/ns/odrl/2/> .
@prefix ex:    <https://example.org/enforce#> .
@prefix act:   <https://example.org/activity#> .
@prefix shop:  <https://example.org/shop#> .
@prefix schema:<http://schema.org/> .
@prefix math:  <http://www.w3.org/2000/10/swap/math#> .
@prefix xsd:   <http://www.w3.org/2001/XMLSchema#> .

{ ?ins a ins:Insight ; ins:expiresAt ?exp . [] ex:now ?now . ?exp math:lessThan ?now . }
=> { ?ins a ex:Expired . } .

{
  ?pol a odrl:Policy ;
       odrl:permission [
         odrl:action      odrl:use ;
         odrl:target      ?ins ;
         odrl:constraint [
           odrl:leftOperand  odrl:purpose ;
           odrl:operator     odrl:eq ;
           odrl:rightOperand "shopping_assist"
         ]
       ] .
  ?ins a ins:Insight .
  ?req odrl:action odrl:use ;
       odrl:constraint [ odrl:leftOperand odrl:purpose ; odrl:rightOperand "shopping_assist" ] .
}
=> { ?req a ex:Allowed ; ex:target ?ins . } .

{ ?req a ex:Allowed ; ex:target ?ins . ?ins a ex:Expired . }
=> { ?req a ex:Blocked ; ex:reason "expired" . } .

{ ?req a ex:Allowed . [] ex:now ?now . }
=> { _:a a act:Decision ; act:at ?now ; act:request ?req ; act:outcome "Allowed" . } .

{ ?req a ex:Blocked ; ex:reason ?r . [] ex:now ?now . }
=> { _:a a act:Decision ; act:at ?now ; act:request ?req ; act:outcome "Blocked" ; act:reason ?r . } .

{ ?ins a ex:Expired . [] ex:now ?now . }
=> { _:d a act:Duty ; act:type "delete_due" ; act:at ?now ; act:target ?ins . } .

{
  ?req a ex:Allowed ; ex:target ?ins .
  ?ins a ins:Insight ; ins:metric "sugar_g_per_serving" ; ins:threshold ?thr .
  ?scan shop:scannedProduct ?p .
  ?p schema:name ?name ; schema:sugarContent ?sug .
  ?alt schema:name ?an ; schema:sugarContent ?as .
  ?as math:lessThan ?sug .
  ?sug math:notLessThan ?thr .
}
=> { ?scan shop:note "High sugar" ; shop:suggestedAlternative ?alt . } .
`;

    // ------- eye-js loader -------
    let n3reasoner = null;
    async function eye() {
      if (n3reasoner) return n3reasoner;
      const mod = await import("https://eyereasoner.github.io/eye-js/latest/dynamic-import.js");
      if (!mod?.eyereasoner?.n3reasoner) throw new Error("eye-js n3reasoner not available");
      n3reasoner = mod.eyereasoner.n3reasoner;
      return n3reasoner;
    }
    async function derive(graphs) {
      const r = await eye();
      return await r(graphs, null, { output: "derivations", outputType: "string" });
    }

    // ------- small helpers -------
    const nowISO = () => new Date().toISOString();
    const plusHoursISO = (h)=> new Date(Date.now()+h*3600*1000).toISOString();

    function extractDecision(n3) {
      const outcome = /act:outcome\s+"(Allowed|Blocked)"/.exec(n3)?.[1] || "(none)";
      const expired = /ex:Expired\b/.test(n3);
      const suggQ   = /shop:suggestedAlternative\s+([^\s]+)\s*\./.exec(n3)?.[1] || null;
      return { outcome, expired, suggQ };
    }
    function nameForQname(qname, catalogTtl) {
      if (!qname) return null;
      const re = new RegExp(qname.replace(/[.*+?^${}()|[\]\\]/g,'\\$&') + `[\\s\\S]*?schema:name\\s+"([^"]+)"`);
      return (catalogTtl.match(re)||[])[1] || null;
    }

    function showList(id, text) { document.getElementById(id).textContent = (text||"").trim(); }

    // ------- Orchestrator -------
    async function runDemo(){
      runBtn.disabled = true;
      try {
        // Build inputs
        const created = nowISO();
        const expires = plusHoursISO(2);
        const now     = nowISO();

        const pTTL = profileTTL;
        const cTTL = contextTTL({created, expires});
        const nTTL = nowTTL(now);
        const rTTL = requestTTL;
        const cat  = catalogTTL;
        const sTTL = scanTTL;

        showList("profileBox", pTTL);
        showList("contextBox", cTTL);
        showList("nowBox", nTTL);
        showList("requestBox", rTTL);
        showList("catalogBox", cat);
        showList("scanBox", sTTL);

        // PHONE: derive insight + policy with eye-js
        setStatus("PHONE: deriving insight + policy …");
        addTimeline("PICKUP", 'scanner="self-scanner" retailer="Delfour"');
        addTimeline("AGENT-DIALOG", "capabilities received");

        const phoneOut = (await derive([pTTL, cTTL, PHONE_RULES])).trim();
        // Split insight vs policy for display convenience (still one derivation bag)
        const insightPart = phoneOut.split("\n").filter(l=>/ins:Insight|ins:metric|ins:threshold|ins:scope|ins:retailer|ins:expiresAt|ins:createdAt/.test(l)).join("\n");
        const policyPart  = phoneOut.split("\n").filter(l=>/odrl:Policy|odrl:permission|odrl:prohibition|odrl:duty|odrl:profile|odrl:action|odrl:constraint/.test(l)).join("\n");

        showList("insightBox", insightPart || phoneOut);
        showList("policyBox",  policyPart  || phoneOut);
        addTimeline("INSIGHT", "neutral low-sugar envelope emitted");
        addTimeline("POLICY",  "ODRL policy emitted");

        // SCANNER: auth + audit + suggestion with eye-js
        setStatus("SCANNER: authorization + audit + suggestion …");
        const scanOut = (await derive([phoneOut, nTTL, rTTL, cat, sTTL, SCANNER_RULES])).trim();
        showList("auditBox", scanOut);

        // Decision + banner
        const { outcome, expired, suggQ } = extractDecision(scanOut);
        const altName = nameForQname(suggQ, cat);
        const banner = (outcome === "Blocked")
          ? { headline: "Policy blocked action", product_name: null, note: "Expired or prohibited", suggested_alternative: null }
          : { headline: altName ? "Track sugar per serving while you scan" : "Scan complete",
              product_name: "Classic Tea Biscuits",
              note: altName ? "High sugar" : null,
              suggested_alternative: altName || null };
        document.getElementById("bannerBox").textContent = JSON.stringify(banner, null, 2);

        addTimeline("AUTH", outcome === "Allowed" ? "Allowed (use@shopping_assist)" : (expired ? "Blocked (expired)" : "Blocked"));
        addTimeline("RUNTIME", "banner written");
        addTimeline("DROP", "scanner returned; session closed");

        // Reason + Checks + Summary
        const REASON = "Household requires low-sugar guidance (diabetes in POD). Neutral insight scoped to device+event+retailer; expires soon.";
        showList("reasonBox", REASON);

        const checks = [
          ["insight_nonempty", !!phoneOut.trim()],
          ["minimization_no_sensitive_terms", !/diabetes|medical/i.test(phoneOut)],
          ["scope_has_device_event_expiry", /ins:scopeDevice|ins:scopeEvent|ins:expiresAt/.test(phoneOut)],
          ["runtime_present", !!banner.headline],
          ["behavior_suggests_on_high_sugar", !!banner.note],
          ["audit_has_decision", /act:Decision/.test(scanOut)]
        ];
        showChecks(checks);

        document.getElementById("summaryBox").textContent = JSON.stringify({
          decision: outcome,
          expired,
          suggestedAlternative: altName || null
        }, null, 2);

        setStatus("Done.");
      } catch (e) {
        console.error(e);
        setStatus("Error: " + (e?.message || e));
      } finally {
        runBtn.disabled = false;
      }
    }

    runBtn.addEventListener("click", runDemo);
    setStatus("Ready.");
  </script>
</body>
</html>

