<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Body Mass Index</title>
  <style>
    :root {
      --bg: #f7f8fb;
      --panel: #ffffff;
      --panel-2: #ffffff;
      --border: #e3e6ee;
      --text: #0b1324;
      --muted: #5b6779;
      --accent: #0b6bcb;
      --accent-2: #5a3df0;
      --good: #1a7f37;
      --warn: #b7791f;
      --bad: #b42318;
      --card-radius: 14px;
      --gap: 14px;
      --shadow: 0 6px 18px rgba(10,20,30,.08);
      --mono: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      --sans: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,"Helvetica Neue",Arial,"Apple Color Emoji","Segoe UI Emoji";
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin: 0; background: var(--bg); color: var(--text); font-family: var(--sans); line-height: 1.5; }
    a { color: var(--accent); text-decoration: none; }
    h1, h2, h3 { margin: 0 0 .6rem; font-weight: 700; }
    h1 { font-size: clamp(1.2rem, 1.1rem + 1.2vw, 1.9rem); letter-spacing: .2px; }
    h2 { font-size: clamp(1rem, .9rem + .8vw, 1.3rem); color: var(--muted); font-weight: 600; }
    p { margin: .25rem 0 .75rem; color: var(--muted); }
    .wrap { max-width: 820px; margin: 0 auto; padding: 20px; }
    header { display: grid; gap: 6px; margin-bottom: 12px; }
    header .meta { color: var(--muted); font-size: .95rem; }

    /* Vertical layout: single column stack */
    .grid { display: grid; grid-template-columns: 1fr; gap: var(--gap); }

    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--card-radius);
      padding: 16px;
      box-shadow: var(--shadow);
    }
    .panel + .panel { margin-top: var(--gap); }

    .row { display: grid; grid-template-columns: 1fr 1fr; gap: var(--gap); }
    @media (max-width: 560px){ .row { grid-template-columns: 1fr; } }

    .field { display: grid; gap: 6px; }
    .field label { color: var(--muted); font-size: .9rem; }
    .field input[type="number"], .field input[type="text"], .field select {
      background: #fff; border: 1px solid var(--border); color: var(--text);
      border-radius: 10px; padding: 10px 12px; font-size: 1rem; outline: none;
    }
    .unit-toggle { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .unit-toggle label { display: inline-flex; gap: 6px; align-items: center; background: #fff; border: 1px solid var(--border); padding: 8px 12px; border-radius: 999px; cursor: pointer; }
    .unit-toggle input { accent-color: var(--accent); }

    .btnbar { display: flex; gap: 8px; flex-wrap: wrap; }
    button, .btn {
      background: linear-gradient(180deg, #2b87ff, #1769e9);
      border: none; color: white; font-weight: 700; letter-spacing: .2px; padding: 10px 14px;
      border-radius: 12px; cursor: pointer; box-shadow: var(--shadow); font-size: .98rem;
    }
    button.secondary { background: #f5f7fb; border: 1px solid var(--border); color: var(--text); font-weight: 600; }
    button.ghost { background: transparent; border: 1px dashed var(--border); color: var(--muted); }

    /* Cards stacked vertically */
    .cards { display: grid; grid-template-columns: 1fr; gap: var(--gap); }

    .card { background: #fff; border: 1px solid var(--border); border-radius: var(--card-radius); padding: 14px; box-shadow: var(--shadow); }
    .card h3 { color: var(--text); font-size: 1.05rem; }
    .mono { font-family: var(--mono); }
    .kv { display: grid; grid-template-columns: auto 1fr; gap: 6px 10px; align-items: baseline; }
    .kv dt { color: var(--muted); }
    .kv dd { margin: 0; }
    .pill { display: inline-block; padding: 3px 8px; border-radius: 999px; font-size: .85rem; font-weight: 700; }
    .pill.good { background: color-mix(in oklab, var(--good) 18%, white); color: var(--good); border: 1px solid color-mix(in oklab, var(--good) 40%, white); }
    .pill.warn { background: color-mix(in oklab, var(--warn) 18%, white); color: #a66b13; border: 1px solid color-mix(in oklab, var(--warn) 40%, white); }
    .pill.bad  { background: color-mix(in oklab, var(--bad) 18%, white);  color: var(--bad); border: 1px solid color-mix(in oklab, var(--bad) 40%, white); }

    .section-title { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
    .section-title small { color: var(--muted); }
    .footer-note { color: var(--muted); font-size: .9rem; margin-top: 10px; }
    .trace { white-space: pre-wrap; font-family: var(--mono); background: #fff; border: 1px solid var(--border); border-radius: 12px; padding: 12px; min-height: 120px; }

    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Body Mass Index</span></h1>
      <p><strong>What this is?</strong> A self‑contained, browser‑only ARC harness for body mass index (BMI). Enter height and weight (metric or US units), then press <em>Run</em>. The page prints a step‑by‑step <em>Trace</em> and an ARC report (Answer • Reason • Check), including category and a healthy‑range weight band for the given height.</p>
      <p class="footer-note">For reproducibility and documentation only; not medical advice.</p>
    </header>

    <div class="grid">
      <!-- Inputs -->
      <section class="panel" aria-labelledby="inputs-h2">
        <div class="section-title">
          <h2 id="inputs-h2">Inputs</h2>
          <div class="btnbar"><button class="secondary" id="demoBtn" type="button">Demo & Run</button></div>
        </div>

        <div class="unit-toggle" role="radiogroup" aria-label="Unit system">
          <label><input type="radio" name="units" value="metric" checked> Metric (kg, cm)</label>
          <label><input type="radio" name="units" value="us"> US (lb, ft+in)</label>
        </div>

        <div class="row" style="margin-top:12px">
          <div class="field" id="weightField">
            <label for="weight">Weight <span class="mono" id="weightUnitLabel">(kg)</span></label>
            <input id="weight" type="number" min="0" step="any" placeholder="e.g., 72" inputmode="decimal" value="72" />
          </div>
          <div class="field" id="heightField">
            <label for="height">Height <span class="mono" id="heightUnitLabel">(cm)</span></label>
            <input id="height" type="number" min="0" step="any" placeholder="e.g., 175" inputmode="decimal" value="179.5" />
          </div>
        </div>

        <div class="row" id="usExtras" style="margin-top:8px; display:none">
          <div class="field">
            <label for="feet">Height (feet)</label>
            <input id="feet" type="number" min="0" step="1" placeholder="e.g., 5" />
          </div>
          <div class="field">
            <label for="inches">Height (inches)</label>
            <input id="inches" type="number" min="0" step="any" placeholder="e.g., 9" />
          </div>
        </div>

        <div class="btnbar" style="margin-top:12px">
          <button id="runBtn" type="button">▶ Run</button>
          <button class="secondary" id="copyOutputsBtn" type="button" title="Copy Answer + Reason + Check">Copy both outputs</button>
        </div>
      </section>

      <!-- Trace -->
      <section class="panel" aria-labelledby="trace-h2">
        <div class="section-title">
          <h2 id="trace-h2">Trace</h2>
          <div class="btnbar">
            <button class="ghost" id="exportTraceBtn" type="button">⬇ Export .txt</button>
          </div>
        </div>
        <div id="trace" class="trace" aria-live="polite">(no run yet)</div>
      </section>
    </div>

    <!-- ARC Output -->
    <section class="panel" aria-labelledby="arc-h2" style="margin-top:16px">
      <div class="section-title">
        <h2 id="arc-h2">ARC Output</h2>
        <div class="btnbar">
          <!-- intentionally no “Style: plain” label -->
          <button class="ghost" id="exportArcBtn" type="button">⬇ Export .txt</button>
        </div>
      </div>

      <div class="cards" id="cards">
        <article class="card" aria-labelledby="answer-h3">
          <h3 id="answer-h3">Answer</h3>
          <div id="answer">(no run yet)</div>
        </article>
        <article class="card" aria-labelledby="reason-h3">
          <h3 id="reason-h3">Reason why</h3>
          <div id="reason">(no run yet)</div>
        </article>
        <article class="card" aria-labelledby="check-h3">
          <h3 id="check-h3">Check (harness)</h3>
          <div id="check">(no run yet)</div>
        </article>
      </div>
    </section>
  </div>

  <script>
    const els = {
      units: () => document.querySelector('input[name="units"]:checked').value,
      weight: document.getElementById('weight'),
      height: document.getElementById('height'),
      feet: document.getElementById('feet'),
      inches: document.getElementById('inches'),
      usExtras: document.getElementById('usExtras'),
      weightUnitLabel: document.getElementById('weightUnitLabel'),
      heightUnitLabel: document.getElementById('heightUnitLabel'),
      answer: document.getElementById('answer'),
      reason: document.getElementById('reason'),
      check: document.getElementById('check'),
      trace: document.getElementById('trace'),
      runBtn: document.getElementById('runBtn'),
      demoBtn: document.getElementById('demoBtn'),
      exportTraceBtn: document.getElementById('exportTraceBtn'),
      exportArcBtn: document.getElementById('exportArcBtn'),
      copyOutputsBtn: document.getElementById('copyOutputsBtn'),
    };

    // Units toggle
    document.querySelectorAll('input[name="units"]').forEach(r => {
      r.addEventListener('change', () => {
        const metric = els.units() === 'metric';
        els.weightUnitLabel.textContent = metric ? '(kg)' : '(lb)';
        els.heightUnitLabel.textContent = metric ? '(cm)' : '(ft+in → cm)';
        els.usExtras.style.display = metric ? 'none' : 'grid';
        // Clear fields when switching systems
        if (metric){
          els.weight.value = '72';
          els.height.value = '179.5';
          els.feet.value = '';
          els.inches.value = '';
        } else {
          els.weight.value = '';
          els.height.value = '';
          els.feet.value = '';
          els.inches.value = '';
        }
      });
    });

    // Helpers
    const round = (num, decimals) => {
      const p = Math.pow(10, decimals);
      return Math.round((num + Number.EPSILON) * p) / p;
    };

    function kgToLb(kg){ return kg * 2.20462262185; }
    function lbToKg(lb){ return lb * 0.45359237; }
    function cmToM(cm){ return cm / 100; }

    function fmtRange(min, max, unit){
      return `${round(min,1)}–${round(max,1)} ${unit}`;
    }

    function category(bmi){
      if (bmi < 18.5) return {label: 'Underweight', cls: 'warn'};
      if (bmi < 25) return {label: 'Normal weight', cls: 'good'};
      if (bmi < 30) return {label: 'Overweight', cls: 'warn'};
      return {label: 'Obesity', cls: 'bad'};
    }

    function collectInputs(){
      const metric = els.units() === 'metric';
      let w_kg, h_cm; let notes = [];
      if (metric){
        const w = parseFloat(els.weight.value);
        const h = parseFloat(els.height.value);
        if (!isFinite(w) || !isFinite(h) || w <= 0 || h <= 0) {
          throw new Error('Please enter positive numeric weight and height.');
        }
        w_kg = w; h_cm = h; notes.push(`Metric input: weight ${w} kg, height ${h} cm.`);
      } else {
        const lb = parseFloat(els.weight.value);
        const ft = parseFloat(els.feet.value || '0');
        const inch = parseFloat(els.inches.value || '0');
        const h_cm_guess = parseFloat(els.height.value);
        if (!isFinite(lb) || lb <= 0) throw new Error('Enter a positive weight (lb).');
        // Prefer ft+in, else accept cm typed in the main height box for convenience
        let totalIn = NaN;
        if (isFinite(ft) && isFinite(inch) && (ft>0 || inch>0)) {
          totalIn = ft * 12 + inch;
        }
        if (!isFinite(totalIn) || totalIn <= 0){
          if (!isFinite(h_cm_guess) || h_cm_guess <= 0) throw new Error('Enter height as ft+in or cm.');
          h_cm = h_cm_guess; notes.push(`US input with cm override: height ${h_cm_guess} cm.`);
        } else {
          h_cm = totalIn * 2.54; notes.push(`US input: ${ft} ft ${inch} in → ${round(h_cm,1)} cm.`);
        }
        w_kg = lbToKg(lb); notes.push(`${lb} lb → ${round(w_kg,2)} kg.`);
      }
      return { w_kg, h_cm, notes };
    }

    function compute(){
      const t0 = performance.now();
      let trace = [];
      try {
        const { w_kg, h_cm, notes } = collectInputs();
        trace.push(...notes);
        const h_m = cmToM(h_cm);
        const bmi = w_kg / (h_m*h_m);
        const bmiRounded = round(bmi, 1);
        const cat = category(bmiRounded);

        // Healthy range for given height
        const min_w = 18.5 * h_m*h_m;
        const max_w = 24.9 * h_m*h_m;
        const rangeKg = fmtRange(min_w, max_w, 'kg');
        const rangeLb = fmtRange(kgToLb(min_w), kgToLb(max_w), 'lb');

        // Build Answer card
        const ans = document.createElement('div');
        ans.innerHTML = `
          <p><strong class="mono">BMI</strong>: <span class="mono" style="font-size:1.15rem">${bmiRounded}</span> <span class="pill ${cat.cls}">${cat.label}</span></p>
          <dl class="kv">
            <dt>Height</dt><dd>${round(h_cm,1)} cm (${round(h_m,2)} m)</dd>
            <dt>Weight</dt><dd>${round(w_kg,1)} kg (${round(kgToLb(w_kg),1)} lb)</dd>
            <dt>Healthy weight<br/>range @ height</dt><dd>${rangeKg}  /  ${rangeLb}</dd>
          </dl>`;
        els.answer.replaceChildren(ans);

        // Build Reason card
        const rs = document.createElement('div');
        rs.innerHTML = `
          <ol>
            <li>Convert units to metric (kg, cm). ${notes.length? '<span class="mono">'+notes.join(' ')+"</span>": ''}</li>
            <li>Convert height to meters: <span class="mono">h = ${round(h_cm,1)} cm = ${round(h_m,2)} m</span>.</li>
            <li>Apply formula <span class="mono">BMI = weight_kg / (height_m)^2</span> → <span class="mono">${round(w_kg,1)} / ${round(h_m,2)}² = ${bmiRounded}</span>.</li>
            <li>Classify using standard bands (Underweight &lt;18.5, Normal 18.5–24.9, Overweight 25–29.9, Obesity ≥30).</li>
            <li>Healthy range @ height: <span class="mono">[18.5, 24.9] × h²</span> → <span class="mono">${rangeKg}</span> (≈ <span class="mono">${rangeLb}</span>).</li>
          </ol>`;
        els.reason.replaceChildren(rs);

        // Build Check card (sanity harness)
        const w_from_bmi = bmiRounded * h_m*h_m;
        const delta_w = Math.abs(w_from_bmi - w_kg);
        const rel = (delta_w / w_kg) * 100;
        const ok = rel < 2.0; // within 2% after rounding
        const ck = document.createElement('div');
        ck.innerHTML = `
          <ul>
            <li>Reconstruction check: <span class="mono">BMI × h² = ${round(w_from_bmi,2)} kg</span> (input was <span class="mono">${round(w_kg,2)} kg</span>) → <strong class="pill ${ok? 'good':'bad'}">${ok? 'OK':'Mismatch'}</strong>.</li>
            <li>Unit invariance: switching display units does not change BMI (dimensionless).</li>
            <li>Numerical stability: results rounded to 1 decimal (BMI) and 1 decimal (ranges) for readability.</li>
          </ul>`;
        els.check.replaceChildren(ck);

        // Trace
        const t1 = performance.now();
        trace.push(`Height (m): ${round(h_m,4)}`);
        trace.push(`BMI (raw): ${bmi}`);
        trace.push(`BMI (rounded 1dp): ${bmiRounded}`);
        trace.push(`Category: ${cat.label}`);
        trace.push(`Range kg: ${rangeKg}`);
        trace.push(`Range lb: ${rangeLb}`);
        trace.push(`Runtime: ${round(t1 - t0, 2)} ms`);
        els.trace.textContent = trace.join('\n');
      } catch (e){
        els.answer.textContent = '(no run yet)';
        els.reason.textContent = '(no run yet)';
        els.check.textContent = '(no run yet)';
        els.trace.textContent = 'Error: ' + e.message;
      }
    }

    // Export helpers
    function download(filename, text){
      const blob = new Blob([text], {type: 'text/plain'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; a.style.display='none';
      document.body.appendChild(a); a.click();
      setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 0);
    }

    els.exportTraceBtn.addEventListener('click', () => {
      download('bmi-trace.txt', els.trace.textContent || '');
    });
    els.exportArcBtn.addEventListener('click', () => {
      const txt = [
        '# Answer',
        strip(els.answer), '',
        '# Reason',
        strip(els.reason), '',
        '# Check',
        strip(els.check)
      ].join('\n');
      download('bmi-arc.txt', txt);
    });

    els.copyOutputsBtn.addEventListener('click', async () => {
      const txt = [
        'Answer:\n' + strip(els.answer),
        'Reason:\n' + strip(els.reason),
        'Check:\n' + strip(els.check)
      ].join('\n\n');
      try { await navigator.clipboard.writeText(txt); toast('Copied Answer + Reason + Check.'); }
      catch { toast('Unable to access clipboard.'); }
    });

    function strip(node){
      const clone = node.cloneNode(true);
      clone.querySelectorAll('style,script').forEach(n => n.remove());
      return clone.textContent.trim().replace(/\n\s*\n\s*\n/g, '\n\n');
    }

    function toast(msg){
      const t = document.createElement('div');
      t.textContent = msg;
      Object.assign(t.style, {
        position:'fixed', inset:'auto 16px 16px auto', background:'#fff', color:'#0b1324',
        border:'1px solid #e3e6ee', padding:'8px 12px', borderRadius:'10px', zIndex:9999,
        boxShadow:'var(--shadow)', opacity:0, transition:'opacity .15s ease, transform .15s ease',
        transform:'translateY(6px)'
      });
      document.body.appendChild(t);
      requestAnimationFrame(()=>{ t.style.opacity=1; t.style.transform='translateY(0)'; });
      setTimeout(()=>{ t.style.opacity=0; t.style.transform='translateY(6px)'; setTimeout(()=>t.remove(), 200); }, 1600);
    }

    // Bind
    els.runBtn.addEventListener('click', compute);
    els.demoBtn.addEventListener('click', () => {
      // Demo: keep metric example
      document.querySelector('input[value="metric"]').checked = true;
      els.usExtras.style.display = 'none';
      els.weightUnitLabel.textContent = '(kg)';
      els.heightUnitLabel.textContent = '(cm)';
      els.weight.value = '72';
      els.height.value = '175';
      els.feet.value = '';
      els.inches.value = '';
      compute();
    });
  </script>
</body>
</html>
