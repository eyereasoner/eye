<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Eco Route — ARC (EYE‑JS, v8)</title>
  <style>
    :root{
      --bg:#ffffff; --ink:#0f172a; --muted:#64748b; --panel:#f8fafc; --border:#e2e8f0;
      --a:#22c55e; --r:#06b6d4; --c:#6366f1;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      --ui: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans";
    }
    html,body{height:100%}
    body{ margin:0; background:#fff; color:var(--ink); font:15px/1.55 var(--ui); }
    .wrap{max-width:980px; margin:28px auto; padding:0 14px;}
    header{display:flex; align-items:center; justify-content:space-between; margin-bottom:14px}
    h1{font-size:20px; margin:0; letter-spacing:.2px}
    .pill{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid var(--border); border-radius:999px; color:var(--muted); background:#fff}
    .card{width:100%; background:var(--panel); border:1px solid var(--border); border-radius:14px; overflow:hidden; margin-bottom:14px}
    .head{display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid var(--border)}
    .head h2{font-size:13px; text-transform:uppercase; letter-spacing:.08em; color:var(--muted); margin:0}
    .body{padding:12px}
    pre{white-space:pre-wrap; background:#fff; border:1px solid var(--border); border-radius:10px; padding:12px; overflow:auto; font-family:var(--mono); font-size:13px; margin:0}
    textarea{width:100%; min-height:200px; background:#fff; color:var(--ink); border:1px solid var(--border); border-radius:10px; padding:10px; font-family:var(--mono); font-size:13px}
    .btns{display:flex; gap:8px; flex-wrap:wrap}
    button{all:unset; background:#fff; border:1px solid var(--border); padding:9px 13px; border-radius:10px; cursor:pointer}
    button:hover{border-color:#cbd5e1}
    .muted{color:var(--muted)}
    .arcbox{background:#fff; border:1px solid var(--border); border-radius:12px; padding:10px; margin:10px 0}
    .arcbox.answer{border-left:10px solid var(--a)}
    .arcbox.reason{border-left:10px solid var(--r)}
    .arcbox.check{border-left:10px solid var(--c)}
    .arclabel{font-size:11px; text-transform:uppercase; letter-spacing:.08em; color:var(--muted); margin-bottom:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Eco Route — <span class="accent">ARC</span> (Answer • Reason • Check)</h1>
      <div class="pill" id="status">Ready</div>
    </header>

    <div class="card">
      <div class="body">
        <p><strong>What this is?</strong> A self‑contained page that calls <em>EYE‑JS</em> to evaluate five N3 rules,
        and renders an ARC report. “Check” re‑evaluates conditions from the reasoner’s own outputs and shows ✓/✗.</p>
        <pre class="muted">R1: compute ex:fuelIndex for each route: distanceKm × (payloadKg/1000) × gradientFactor.
R2: show an eco banner at the depot if the current route’s fuel index exceeds the policy threshold.
R3: suggest the alternative route if it is strictly better (FI_alt &lt; FI_current).
R4: add an estimated saving if the alternative is also within threshold (FI_alt ≤ threshold).
R5: optional comfort index (simple sum) when it’s ≥ 40.</pre>
      </div>
    </div>

    <div class="card">
      <div class="head"><h2>N3 Rules (fixed)</h2></div>
      <div class="body">
        <pre id="rulesView"></pre>
      </div>
    </div>

    <div class="card">
      <div class="head"><h2>Turtle Data (input)</h2></div>
      <div class="body">
        <textarea id="ttl"></textarea>
        <div class="btns" style="margin-top:10px">
          <button onclick="run()">▶ Run</button>
          <button onclick="loadSample()">⟲ Load sample</button>
          <button onclick="copyARC()">Copy ARC</button>
          <button onclick="downloadTxt()">⬇ Export .txt</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="head"><h2>ARC Output</h2><span class="muted">Cards with left borders</span></div>
      <div class="body">
        <div class="arcbox answer"><div class="arclabel">Answer</div><pre id="ans">(no run yet)</pre></div>
        <div class="arcbox reason"><div class="arclabel">Reason why</div><pre id="why">(no run yet)</pre></div>
        <div class="arcbox check"><div class="arclabel">Check (harness)</div><pre id="chk">(no run yet)</pre></div>
      </div>
    </div>
  </div>

<script>
const PFX = `@prefix ex:   <https://example.org/ex#> .
@prefix rdf:  <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix math: <http://www.w3.org/2000/10/swap/math#> .
@prefix xsd:  <http://www.w3.org/2001/XMLSchema#> .`;

const RULES = `${PFX}

# R1 FuelIndex for any route
{ ex:scan1 ex:forShipment ?S.
  ?S ex:payloadKg ?Wkg. ( ?Wkg 1000 ) math:quotient ?Wton.
  ?R a ex:Route; ex:distanceKm ?Dkm; ex:gradientFactor ?Gf.
  ( ?Dkm ?Wton ) math:product ?Work. ( ?Work ?Gf ) math:product ?FuelIndex. }
=> { ?R ex:fuelIndex ?FuelIndex. }.

# R2 Banner if current route over threshold
{ ex:scan1 ex:forShipment ?S. ?S ex:payloadKg ?Wkg. ( ?Wkg 1000 ) math:quotient ?Wton.
  ex:scan1 ex:usesRoute ?R1. ?R1 ex:distanceKm ?D1; ex:gradientFactor ?G1.
  ( ?D1 ?Wton ) math:product ?W1. ( ?W1 ?G1 ) math:product ?Fi1.
  ex:policy ex:fuelIndexThreshold ?T. ?Fi1 math:greaterThan ?T.
  ex:scan1 ex:inDepot ?Depot. }
=> { ex:insight1 a ex:Insight; ex:showEcoBanner ?Depot; ex:fuelIndex ?Fi1. }.

# R3 Suggest alternative when strictly better
{ ex:scan1 ex:forShipment ?S. ?S ex:payloadKg ?Wkg. ( ?Wkg 1000 ) math:quotient ?Wton.
  ex:scan1 ex:usesRoute ?R1. ?R1 ex:distanceKm ?D1; ex:gradientFactor ?G1.
  ( ?D1 ?Wton ) math:product ?W1. ( ?W1 ?G1 ) math:product ?Fi1.
  ex:altRoute ex:distanceKm ?D2; ex:gradientFactor ?G2.
  ( ?D2 ?Wton ) math:product ?W2. ( ?W2 ?G2 ) math:product ?Fi2.
  ?Fi1 math:greaterThan ?Fi2. }
=> { ex:insight1 ex:suggestRoute ex:altRoute. }.

# R4 Estimated saving (guard: alt notGreaterThan threshold)
{ ex:scan1 ex:forShipment ?S. ?S ex:payloadKg ?Wkg. ( ?Wkg 1000 ) math:quotient ?Wton.
  ex:scan1 ex:usesRoute ?R1. ?R1 ex:distanceKm ?D1; ex:gradientFactor ?G1.
  ( ?D1 ?Wton ) math:product ?W1. ( ?W1 ?G1 ) math:product ?Fi1.
  ex:altRoute ex:distanceKm ?D2; ex:gradientFactor ?G2.
  ( ?D2 ?Wton ) math:product ?W2. ( ?W2 ?G2 ) math:product ?Fi2.
  ( ?Fi1 ?Fi2 ) math:difference ?Saving.
  ex:policy ex:fuelIndexThreshold ?T. ?Fi2 math:notGreaterThan ?T. }
=> { ex:insight1 ex:estimatedSaving ?Saving. }.

# R5 Optional comfort index (sum, notLessThan)
{ ?R ex:distanceKm ?D; ex:gradientFactor ?Gf.
  ( ?Gf 10 ) math:product ?Pg. ( ?D ?Pg ) math:sum ?Comfort.
  ?Comfort math:notLessThan 40. }
=> { ?R ex:comfortIndex ?Comfort. }.`;

// Query: collect outputs and inputs
const QUERY = `${PFX}
# Outputs
{ ex:currentRoute ex:fuelIndex ?Fi. } => { _:o ex:out_fuelIndex_current ?Fi. }.
{ ex:altRoute     ex:fuelIndex ?Fi. } => { _:o ex:out_fuelIndex_alt ?Fi. }.
{ ex:insight1 ex:showEcoBanner ?Depot. } => { _:o ex:out_showEcoBanner ?Depot. }.
{ ex:insight1 ex:suggestRoute ?R. } => { _:o ex:out_suggestRoute ?R. }.
{ ex:insight1 ex:estimatedSaving ?S. } => { _:o ex:out_estimatedSaving ?S. }.
{ ex:currentRoute ex:comfortIndex ?C. } => { _:o ex:out_comfort_current ?C. }.
{ ex:altRoute     ex:comfortIndex ?C. } => { _:o ex:out_comfort_alt ?C. }.
# Inputs
{ ex:shipment1   ex:payloadKg ?W. }           => { _:o ex:out_in_payloadKg ?W. }.
{ ex:currentRoute ex:distanceKm ?D. }         => { _:o ex:out_in_distance_current ?D. }.
{ ex:currentRoute ex:gradientFactor ?G. }     => { _:o ex:out_in_gradient_current ?G. }.
{ ex:altRoute     ex:distanceKm ?D. }         => { _:o ex:out_in_distance_alt ?D. }.
{ ex:altRoute     ex:gradientFactor ?G. }     => { _:o ex:out_in_gradient_alt ?G. }.
{ ex:policy       ex:fuelIndexThreshold ?T. } => { _:o ex:out_in_threshold ?T. }.`;

const SAMPLE_TTL = `@prefix ex:   <https://example.org/ex#>.
@prefix rdf:  <http://www.w3.org/1999/02/22-rdf-syntax-ns#>.
@prefix xsd:  <http://www.w3.org/2001/XMLSchema#>.

ex:DepotX a ex:Depot .
ex:shipment1 a ex:Shipment ; ex:payloadKg 2500.0 .
ex:currentRoute a ex:Route ; ex:distanceKm 42.0 ; ex:gradientFactor 1.15 .
ex:altRoute a ex:Route ; ex:distanceKm 38.0 ; ex:gradientFactor 1.05 .
ex:scan1 a ex:ScanEvent ; ex:inDepot ex:DepotX ; ex:atTime "2025-01-01T09:00:00Z"^^xsd:dateTime ; ex:usesRoute ex:currentRoute ; ex:forShipment ex:shipment1 .
# Lower threshold so banner becomes true while alt remains ≤ threshold
ex:policy ex:fuelIndexThreshold 110.0 .`;

function setText(id, s){ const el=document.getElementById(id); if(el) el.textContent=s; }
function status(msg, warn=false){ const el=document.getElementById('status'); el.textContent=msg; el.classList.toggle('warn', !!warn); }

function parseOut(n3){
  const out = {};
  const stmts = n3.split(/\.\s*(?:\r?\n|$)/);
  const numFromTok = (tok) => {
    let t = tok.trim().replace(/[;,]\s*$/, '');
    let m = t.match(/^"([^"]+)"\^\^([^\s]+)$/);
    if (m) { const x = Number(m[1]); return Number.isFinite(x) ? x : null; }
    m = t.match(/^"([^"]+)"$/);
    if (m) { const x = Number(m[1]); return Number.isFinite(x) ? x : null; }
    const x = Number(t);
    return Number.isFinite(x) ? x : null;
  };
  const iriFromTok = (tok) => {
    let t = tok.trim().replace(/[;,]\s*$/, '');
    if (/^<[^>]+>$/.test(t)) return t.slice(1, -1);
    return t;
  };
  for (const st of stmts) {
    if (!st.includes('ex:out_')) continue;
    const rePO = /(ex:out_[A-Za-z_]+)\s+("[^"]+"(?:\^\^[^\s;.,]+)?|<[^>]+>|[^\s;.,]+)/g;
    let m;
    while ((m = rePO.exec(st)) !== null) {
      const pred = m[1], obj = m[2];
      const num = numFromTok(obj);
      out[pred] = (num !== null) ? num : iriFromTok(obj);
    }
  }
  return out;
}

async function eyeRun(data, query){
  const mod = await import('https://eyereasoner.github.io/eye-js/2/latest/dynamic-import.js');
  return await mod.eyereasoner.n3reasoner(data, query);
}

function fmt(x, d=2){ return (typeof x === 'number' && Number.isFinite(x)) ? x.toFixed(d) : String(x); }
function mark(ok){ return ok ? '✓' : '✗'; }

async function run(){
  const ttl = document.getElementById('ttl').value.trim();
  if(!ttl){
    setText('ans','⛔ Please provide Turtle input or click “Load sample”.');
    setText('why','(no run)'); setText('chk','(no run)');
    status('No input', true); return;
  }
  status('Reasoning…');
  const data = `${RULES}\n\n${ttl}`;
  try{
    const n3 = await eyeRun(data, QUERY);
    const o = parseOut(n3);

    // Answer
    const ans = [];
    ans.push('✅ Insight envelope');
    let asserted = false;
    if('ex:out_fuelIndex_current' in o){ ans.push(`fuelIndex_current = ${fmt(o['ex:out_fuelIndex_current'])}`); asserted = true; }
    if('ex:out_fuelIndex_alt' in o){ ans.push(`fuelIndex_alt = ${fmt(o['ex:out_fuelIndex_alt'])}`); asserted = true; }
    if('ex:out_showEcoBanner' in o){ ans.push(`showEcoBanner = ${o['ex:out_showEcoBanner']}`); asserted = true; }
    if('ex:out_suggestRoute' in o){ ans.push(`suggestRoute = ${o['ex:out_suggestRoute']}`); asserted = true; }
    if('ex:out_estimatedSaving' in o){ ans.push(`estimatedSaving = ${fmt(o['ex:out_estimatedSaving'])}`); asserted = true; }
    if('ex:out_comfort_current' in o){ ans.push(`comfortIndex_current = ${fmt(o['ex:out_comfort_current'],1)}`); asserted = true; }
    if('ex:out_comfort_alt' in o){ ans.push(`comfortIndex_alt = ${fmt(o['ex:out_comfort_alt'],1)}`); asserted = true; }
    if(asserted) ans.splice(1,0,'—'); else ans.push('(no assertions derived)');
    setText('ans', ans.join('\n'));

    // Reason why
    let R = "We apply the five N3 rules R1–R5 to the input facts.\n\n";
    R += "Key derived values:\n";
    if('ex:out_fuelIndex_current' in o) R += ` • FI(current) = ${fmt(o['ex:out_fuelIndex_current'])}\n`;
    if('ex:out_fuelIndex_alt' in o) R += ` • FI(alt)     = ${fmt(o['ex:out_fuelIndex_alt'])}\n`;
    if('ex:out_estimatedSaving' in o) R += ` • Saving      = ${fmt(o['ex:out_estimatedSaving'])}\n`;
    if('ex:out_showEcoBanner' in o) R += ` • Banner at   = ${o['ex:out_showEcoBanner']}\n`;
    if('ex:out_suggestRoute' in o) R += ` • Suggest     = ${o['ex:out_suggestRoute']}\n`;
    if('ex:out_comfort_current' in o) R += ` • Comfort(cur)= ${fmt(o['ex:out_comfort_current'],1)}\n`;
    if('ex:out_comfort_alt' in o) R += ` • Comfort(alt)= ${fmt(o['ex:out_comfort_alt'],1)}\n`;
    setText('why', R);

    // Check — evaluate conditions from the EYE outputs and show ✓/✗
    const FI1 = o['ex:out_fuelIndex_current'];
    const FI2 = o['ex:out_fuelIndex_alt'];
    const T   = o['ex:out_in_threshold'];

    let C = "Cross‑check from EYE outputs:\n";
    if(typeof FI1 === 'number') C += ` • FI(current) = ${fmt(FI1)}\n`;
    if(typeof FI2 === 'number') C += ` • FI(alt)     = ${fmt(FI2)}\n`;
    if(typeof T === 'number'){
      const banner = FI1 > T;
      const suggest = FI2 < FI1;
      const altOK = FI2 <= T;
      const saving = (typeof FI1==='number' && typeof FI2==='number') ? (FI1-FI2) : NaN;
      C += ` • Banner condition (FI1>T)? ${mark(banner)}\n`;
      C += ` • Suggest alt (FI2<FI1)? ${mark(suggest)}\n`;
      C += ` • Alt within threshold (FI2≤T)? ${mark(altOK)}\n`;
      C += ` • Saving = ${fmt(saving)}\n`;
      const all = banner && suggest && altOK;
      C += ` • All checks ${all ? 'passed ✓' : 'failed ✗'}\n`;
    }
    setText('chk', C);

    status('EYE‑JS ✓');
  }catch(err){
    setText('ans','⛔ EYE‑JS error: '+ (err?.message || String(err)));
    setText('why','(no run)'); setText('chk','(no run)');
    status('Error', true);
  }
}

function loadSample(){ document.getElementById('ttl').value = SAMPLE_TTL; run(); }
function copyARC(){
  const txt = [document.getElementById('ans').textContent,
               document.getElementById('why').textContent,
               document.getElementById('chk').textContent].join('\n\n');
  navigator.clipboard?.writeText(txt).catch(()=>{});
}
function downloadTxt(){
  const blob=new Blob([document.getElementById('ans').textContent, '\n\n',
                       document.getElementById('why').textContent, '\n\n',
                       document.getElementById('chk').textContent], {type:'text/plain'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='eco_route_arc.txt'; a.click();
}

// Bootstrap
document.getElementById('rulesView').textContent = RULES;
document.getElementById('ttl').value = SAMPLE_TTL;
window.addEventListener('DOMContentLoaded', run);
</script>
</body>
</html>
