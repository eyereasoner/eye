<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Eco-Route Insight — ARC</title>
  <style>
    :root{
      --bg:#fff; --ink:#111827; --muted:#6b7280; --panel:#f8fafc; --border:#e5e7eb; --accent:#0ea5e9;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --ui: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      --green:#10b981; --blue:#3b82f6; --amber:#f59e0b;
    }
    body{ margin:0; background:#fff; color:var(--ink); font:15px/1.6 var(--ui); }
    .wrap{max-width:980px; margin:36px auto; padding:0 16px;}
    header{display:flex; align-items:center; justify-content:space-between; margin-bottom:16px}
    h1{font-size:22px; margin:0; letter-spacing:.2px}
    .pill{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid var(--border); border-radius:999px; color:var(--muted); background:#fff}
    .row{display:flex; flex-direction:column; gap:16px}
    .card{background:var(--panel); border:1px solid var(--border); border-radius:14px; overflow:hidden}
    .head{display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid var(--border)}
    .head h2{font-size:13px; text-transform:uppercase; letter-spacing:.08em; color:var(--muted); margin:0}
    .body{padding:12px}
    textarea{width:100%; min-height:220px; background:#fff; color:var(--ink); border:1px solid var(--border); border-radius:10px; padding:12px; font-family:var(--mono); font-size:14px; line-height:1.55}
    pre{white-space:pre-wrap; background:#fff; border:1px solid var(--border); border-radius:10px; padding:12px; overflow:auto; font-family:var(--mono); font-size:13.5px}
    button{all:unset; background:#fff; border:1px solid var(--border); padding:8px 12px; border-radius:10px; cursor:pointer}
    button:hover{border-color:#cbd5e1}
    .arc-grid{display:flex; flex-direction:column; gap:12px}
    .arc-card{background:#fff; border:1px solid var(--border); border-radius:14px; overflow:hidden}
    .arc-card .ac-head{display:flex; align-items:center; gap:8px; padding:10px 12px; border-bottom:1px solid var(--border); font-size:12px; letter-spacing:.08em; text-transform:uppercase; color:var(--muted)}
    .arc-card .ac-body{padding:12px}
    .debug{display:none}
    .link{color:#0ea5e9; cursor:pointer; text-decoration:underline}
  </style>
  <!-- Load N3.js UMD build (global N3) -->
  <script src="https://unpkg.com/n3@1.17.3/browser/n3.min.js"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Eco-Route Insight — <span class="accent">ARC</span> (Answer • Reason • Check)</h1>
      <div style="display:flex;gap:10px;align-items:center">
        <span class="link" onclick="toggleDbg()">Show debug</span>
        <div class="pill" id="status">Loading N3.js…</div>
      </div>
    </header>

    <div class="card" style="margin-bottom:16px">
      <div class="body">
        <p><strong>What this is?</strong> A self-contained, browser page that computes an eco-route
        insight from a tiny Turtle snippet. It uses <code>N3.js</code> to parse Turtle and then applies
        specialized rules (fuel index, banners, suggestion, saving, comfort).</p>
        <div class="card" style="margin-bottom:16px">
          <div class="body">
            <p><strong>What this is?</strong> A self-contained, browser page that computes an eco-route
            insight from a tiny Turtle snippet. It uses <code>N3.js</code> to parse Turtle and then applies:</p>
            <ul>
              <li><strong>R1</strong>: compute <code>ex:fuelIndex</code> for each route:
                <code>distanceKm × (payloadKg/1000) × gradientFactor</code>.</li>
              <li><strong>R2</strong>: show an eco banner at the depot if the current route’s fuel index
                exceeds the policy threshold.</li>
              <li><strong>R3</strong>: suggest the alternative route if it is strictly better
                (<code>FI_alt &lt; FI_current</code>).</li>
              <li><strong>R4</strong>: add an estimated saving if the alternative is also within
                threshold (<code>FI_alt ≤ threshold</code>).</li>
              <li><strong>R5</strong>: optional comfort index (simple sum) when it’s ≥ 40.</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="card">
        <div class="head">
          <h2>Turtle Data (input)</h2>
          <div style="display:flex;gap:8px;align-items:center">
            <button onclick="run()">▶ Run</button>
            <button onclick="loadSample()">⟲ Load sample</button>
          </div>
        </div>
        <div class="body">
          <textarea id="ttl" spellcheck="false"></textarea>
        </div>
      </div>

      <div class="card">
        <div class="head">
          <h2>ARC Output</h2>
          <div style="display:flex;gap:8px;align-items:center">
            <button onclick="downloadARC()">⬇ Export .txt</button>
          </div>
        </div>
        <div class="body">
          <div class="arc-grid">
            <div class="arc-card">
              <div class="ac-head">Answer</div>
              <div class="ac-body"><pre id="ans">(no run yet)</pre></div>
            </div>
            <div class="arc-card">
              <div class="ac-head">Reason why</div>
              <div class="ac-body"><pre id="why">(no run yet)</pre></div>
            </div>
            <div class="arc-card">
              <div class="ac-head">Check (harness)</div>
              <div class="ac-body"><pre id="chk">(no run yet)</pre></div>
            </div>
          </div>
        </div>
      </div>

      <div class="card debug" id="dbgCard">
        <div class="head"><h2>Debug — Parsed triples</h2></div>
        <div class="body"><pre id="dbg">(hidden)</pre></div>
      </div>
    </div>
  </div>

<script>
function toggleDbg(){
  const c=document.getElementById('dbgCard');
  c.style.display = (c.style.display==='none' || c.style.display==='') ? 'block':'none';
}
const NS = {
  ex:  'https://example.org/ex#',
  xsd: 'http://www.w3.org/2001/XMLSchema#'
};
function qn(term){
  if(!term) return '';
  if(term.termType==='NamedNode'){
    if(term.value.startsWith(NS.ex)) return 'ex:'+term.value.slice(NS.ex.length);
    return '<'+term.value+'>';
  }
  if(term.termType==='Literal'){
    if(term.datatype && term.datatype.value.startsWith(NS.xsd)){
      return term.value+'^^xsd:'+term.datatype.value.slice(NS.xsd.length);
    }
    return JSON.stringify(term.value);
  }
  return term.value || String(term);
}
function numberFrom(store, s, p){
  const quads = store.getQuads(s, p, null, null);
  if(!quads.length) return NaN;
  const lit = quads[0].object;
  const v = parseFloat(lit.value);
  return isFinite(v) ? v : NaN;
}
function namedFrom(store, s, p){
  const quads = store.getQuads(s, p, null, null);
  if(!quads.length) return '';
  return qn(quads[0].object);
}
function datetimeFrom(store, s, p){
  const quads = store.getQuads(s, p, null, null);
  if(!quads.length) return '';
  return quads[0].object.value; // ISO string value
}

function inferFromStore(store){
  const DF = N3.DataFactory;
  const ex = (local)=> DF.namedNode(NS.ex+local);

  const scan1 = ex('scan1'), shipment1 = ex('shipment1');
  const current = ex('currentRoute'), alt = ex('altRoute'), policy = ex('policy');

  const depotQN = namedFrom(store, scan1, ex('inDepot')) || 'ex:DepotX';
  const issuedISO = datetimeFrom(store, scan1, ex('atTime')) || '2025-01-01T09:00:00Z';

  const payload = numberFrom(store, shipment1, ex('payloadKg'));
  const D1 = numberFrom(store, current, ex('distanceKm'));
  const G1 = numberFrom(store, current, ex('gradientFactor'));
  const D2 = numberFrom(store, alt, ex('distanceKm'));
  const G2 = numberFrom(store, alt, ex('gradientFactor'));
  const T  = numberFrom(store, policy, ex('fuelIndexThreshold'));

  const problems=[];
  if(!isFinite(payload)) problems.push('shipment1/payloadKg');
  if(!isFinite(D1)) problems.push('currentRoute/distanceKm');
  if(!isFinite(G1)) problems.push('currentRoute/gradientFactor');
  if(!isFinite(D2)) problems.push('altRoute/distanceKm');
  if(!isFinite(G2)) problems.push('altRoute/gradientFactor');
  if(!isFinite(T))  problems.push('policy/fuelIndexThreshold');

  const Wton = payload/1000;
  const FI1  = D1*Wton*G1;
  const FI2  = D2*Wton*G2;
  const showBanner = FI1 > T;
  const suggestAlt = FI1 > FI2;
  const saving = FI1 - FI2;
  const altOk = FI2 <= T;
  const comfort1 = D1 + (G1*10);
  const comfort2 = D2 + (G2*10);
  const hasC1 = comfort1 >= 40;
  const hasC2 = comfort2 >= 40;

  const envelope = {
    audience: depotQN,
    allowedUse: 'ui.eco.banner',
    issuedAt: issuedISO.replace('Z','+00:00'),
    expiry: new Date(new Date(issuedISO).getTime()+4*3600*1000).toISOString().replace('.000','').replace('Z','+00:00'),
    assertions: {
      fuelIndex_current: +FI1.toFixed(2),
      fuelIndex_alt: +FI2.toFixed(2),
      ...(showBanner ? {showEcoBanner: depotQN} : {}),
      ...(suggestAlt ? {suggestRoute: 'ex:altRoute'} : {}),
      ...((showBanner && suggestAlt && altOk) ? {estimatedSaving: +saving.toFixed(2)} : {}),
      ...(hasC1 ? {comfortIndex_current: +comfort1.toFixed(1)} : {}),
      ...(hasC2 ? {comfortIndex_alt: +comfort2.toFixed(1)} : {})
    }
  };
  envelope.signature = btoa(JSON.stringify(envelope)).replace(/=+$/,'');

  const triples = store.getQuads(null,null,null,null)
    .map(q => `${qn(q.subject)} ${qn(q.predicate)} ${qn(q.object)} .`).join('\n');

  return {depotQN, payload, D1, G1, D2, G2, T, FI1, FI2, showBanner, suggestAlt, saving, altOk, comfort1, comfort2, hasC1, hasC2, problems, envelope, triples};
}

function fmt(x,n=2){ return Number.isFinite(x) ? x.toFixed(n) : String(x); }

function run(){
  const ttl = document.getElementById('ttl').value;
  try{
    // Prefer N3.Parser, fallback to global constructor name if needed
    const ParserCtor = (N3 && N3.Parser) ? N3.Parser : (window.Parser || null);
    if(!ParserCtor) throw new Error("N3.Parser not available");
    const parser = new ParserCtor({ format: 'text/turtle' });
    const quads = parser.parse(ttl);
    const store = new N3.Store(quads);
    const r = inferFromStore(store);

    const ans = [];
    if(r.problems.length){
      ans.push('⛔ Missing/invalid inputs in Turtle: ' + r.problems.join(', '));
    } else if(!(r.showBanner || r.suggestAlt)){
      ans.push('⛔ No eco-nudge is warranted under current numbers.');
    } else {
      ans.push('✅ Insight envelope (audience-scoped, short-lived)\n');
      ans.push(JSON.stringify(r.envelope, null, 2));
      ans.push('\nHuman-readable:');
      if(r.showBanner) ans.push(' • Show eco banner at ' + r.depotQN);
      if(r.suggestAlt) ans.push(' • Suggest alternative route' + (r.altOk ? ' (expected saving ≈ '+fmt(r.saving,2)+')' : ''));
    }
    document.getElementById('ans').textContent = ans.join('\n');

    const why = [];
    why.push('Fuel index: distanceKm × (payloadKg/1000) × gradientFactor');
    why.push('Current: ' + fmt(r.D1,1) + ' × (' + fmt(r.payload,1) + '/1000) × ' + fmt(r.G1,2) + ' = ' + fmt(r.FI1,2));
    why.push('Alt    : ' + fmt(r.D2,1) + ' × (' + fmt(r.payload,1) + '/1000) × ' + fmt(r.G2,2) + ' = ' + fmt(r.FI2,2));
    why.push('Policy : banner if current > ' + fmt(r.T,1) + '; suggest alt if alt < current; saving if alt ≤ threshold.');
    document.getElementById('why').textContent = why.join('\n');

    const chk = [];
    chk.push(r.problems.length ? '• Parse completed with missing fields. ✗' : '• Turtle parsed with N3.js and all required fields present. ✓');
    chk.push(r.showBanner ? '• Banner condition holds (current > threshold). ✓' : '• Current ≤ threshold → no banner. ✓');
    chk.push(r.suggestAlt ? '• Alternative strictly better (alt < current). ✓' : '• Alternative not strictly better → no suggestion. ✓');
    chk.push((r.showBanner && r.suggestAlt && r.altOk) ? '• Saving asserted; alt ≤ threshold. ✓' : '• Saving guard check complete. ✓');
    chk.push((r.hasC1 || r.hasC2) ? '• Comfort index added where ≥ 40. ✓' : '• Comfort index skipped (< 40). ✓');
    document.getElementById('chk').textContent = chk.join('\n');

    document.getElementById('dbg').textContent = r.triples;
    document.getElementById('status').textContent = 'Computed';
  }catch(e){
    document.getElementById('ans').textContent = '⛔ Parse error: ' + (e && e.message ? e.message : String(e));
    document.getElementById('why').textContent = '';
    document.getElementById('chk').textContent = '';
    document.getElementById('status').textContent = 'Error';
    document.getElementById('dbg').textContent = '';
  }
}

function downloadARC(){
  const blob = new Blob([
    document.getElementById('ans').textContent, '\n\n',
    document.getElementById('why').textContent, '\n\n',
    document.getElementById('chk').textContent
  ],{type:'text/plain'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='eco_route_insight_output.txt'; a.click();
}

function loadSample(){
  document.getElementById('ttl').value = [
    '@prefix ex:   <https://example.org/ex#>.',
    '@prefix rdf:  <http://www.w3.org/1999/02/22-rdf-syntax-ns#>.',
    '@prefix xsd:  <http://www.w3.org/2001/XMLSchema#>.',
    '',
    'ex:DepotX a ex:Depot .',
    'ex:shipment1 a ex:Shipment ; ex:payloadKg 2500.0 .',
    'ex:currentRoute a ex:Route ; ex:distanceKm 42.0 ; ex:gradientFactor 1.15 .',
    'ex:altRoute a ex:Route ; ex:distanceKm 38.0 ; ex:gradientFactor 1.05 .',
    'ex:scan1 a ex:ScanEvent ; ex:inDepot ex:DepotX ; ex:atTime "2025-01-01T09:00:00Z"^^xsd:dateTime ; ex:usesRoute ex:currentRoute ; ex:forShipment ex:shipment1 .',
    'ex:policy ex:fuelIndexThreshold 120.0 .'
  ].join('\n');  /* real newlines */
}

// When N3 is loaded, preload sample and auto-run
window.addEventListener('DOMContentLoaded', () => {
  const wait = () => (window.N3 && N3.Parser) ? Promise.resolve() : new Promise(r=>setTimeout(r,50)).then(wait);
  wait().then(()=>{ loadSample(); run(); document.getElementById('status').textContent='Ready'; });
});
</script>
</body>
</html>

