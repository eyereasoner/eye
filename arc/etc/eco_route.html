<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Eco‑Route — ARC</title>
  <style>
    :root{
      --bg:#fff; --ink:#111827; --muted:#6b7280; --panel:#f8fafc; --border:#e5e7eb; --accent:#0ea5e9;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --ui: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      --green:#10b981; --blue:#3b82f6; --amber:#f59e0b;
    }
    body{ margin:0; background:#fff; color:var(--ink); font:15px/1.6 var(--ui); }
    .wrap{max-width:980px; margin:36px auto; padding:0 16px;}
    header{display:flex; align-items:center; justify-content:space-between; margin-bottom:16px}
    h1{font-size:22px; margin:0; letter-spacing:.2px}
    .pill{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid var(--border); border-radius:999px; color:var(--muted); background:#fff}
    .row{display:flex; flex-direction:column; gap:16px}
    .card{background:var(--panel); border:1px solid var(--border); border-radius:14px; overflow:hidden}
    .head{display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid var(--border)}
    .head h2{font-size:13px; text-transform:uppercase; letter-spacing:.08em; color:var(--muted); margin:0}
    .body{padding:12px}
    textarea{width:100%; min-height:280px; background:#fff; color:var(--ink); border:1px solid var(--border); border-radius:10px; padding:12px; font-family:var(--mono); font-size:14px; line-height:1.55}
    pre{white-space:pre-wrap; background:#fff; border:1px solid var(--border); border-radius:10px; padding:12px; overflow:auto; font-family:var(--mono); font-size:13.5px}
    button{all:unset; background:#fff; border:1px solid var(--border); padding:8px 12px; border-radius:10px; cursor:pointer}
    button:hover{border-color:#cbd5e1}
    .arc-grid{display:flex; flex-direction:column; gap:12px}
    .arc-card{background:#fff; border:1px solid var(--border); border-radius:14px; overflow:hidden}
    .arc-card .ac-head{display:flex; align-items:center; gap:8px; padding:10px 12px; border-bottom:1px solid var(--border); font-size:12px; letter-spacing:.08em; text-transform:uppercase; color:var(--muted)}
    .arc-card .ac-body{padding:12px}
    .arc-card pre{margin:0; background:#fff; border:1px solid #eef2f7}
    .arc-card.answer{border-left:4px solid var(--green)}
    .arc-card.reason{border-left:4px solid var(--blue)}
    .arc-card.check{border-left:4px solid var(--amber)}
    .debug{display:none}
    .link{color:#0ea5e9; cursor:pointer; text-decoration:underline}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Eco‑Route — <span class="accent">ARC</span></h1>
      <div style="display:flex;gap:10px;align-items:center">
        <span class="link" onclick="toggleDbg()">Show debug</span>
        <div class="pill" id="status">Ready</div>
      </div>
    </header>

    <div class="card" style="margin-bottom:16px">
      <div class="body">
        <p><strong>What this is?</strong> Edit the Turtle below and press <em>Run</em>. If your Turtle came from a single‑line JSON string,
        click <em>↯ Fix \n</em> once to convert <code>\\n</code> into real line breaks.</p>
      </div>
    </div>

    <div class="row">
      <div class="card">
        <div class="head">
          <h2>Turtle Data (input)</h2>
          <div style="display:flex;gap:8px;align-items:center">
            <button onclick="run()">▶ Run</button>
            <button onclick="loadSample()">⟲ Load sample</button>
            <button onclick="fixEscapes()">↯ Fix \\n</button>
          </div>
        </div>
        <div class="body">
          <textarea id="ttl" spellcheck="false"></textarea>
        </div>
      </div>

      <div class="card">
        <div class="head">
          <h2>ARC Output</h2>
          <div style="display:flex;gap:8px;align-items:center">
            <button onclick="downloadARC()">⬇ Export .txt</button>
          </div>
        </div>
        <div class="body">
          <div class="arc-grid">
            <div class="arc-card answer">
              <div class="ac-head">Answer</div>
              <div class="ac-body"><pre id="ans">(no run yet)</pre></div>
            </div>
            <div class="arc-card reason">
              <div class="ac-head">Reason why</div>
              <div class="ac-body"><pre id="why">(no run yet)</pre></div>
            </div>
            <div class="arc-card check">
              <div class="ac-head">Check (harness)</div>
              <div class="ac-body"><pre id="chk">(no run yet)</pre></div>
            </div>
          </div>
        </div>
      </div>

      <div class="card debug" id="dbgCard">
        <div class="head"><h2>Debug — What I parsed</h2></div>
        <div class="body">
          <pre id="dbg">(hidden)</pre>
        </div>
      </div>
    </div>
  </div>

<script>
function toggleDbg(){
  const c=document.getElementById('dbgCard');
  c.style.display = (c.style.display==='none' || c.style.display==='') ? 'block':'none';
}

function normalize(s){
  return s.replace(/\\\\n/g,'\n').replace(/\\n/g,'\n').replace(/\\r\\n/g,'\n').replace(/\\r/g,'\n');
}

// Tokenize TTL into statements terminated by "." followed by whitespace/EoF
function toStatements(ttl){
  ttl = normalize(ttl);
  const out = [];
  let buf = '';
  for(let i=0;i<ttl.length;i++){
    const c = ttl[i];
    buf += c;
    if(c==='.' && (i+1===ttl.length || /\s/.test(ttl[i+1]))){
      out.append = out.push || out.append; // safety for some environments
      out.push(buf.trim());
      buf='';
    }
  }
  if(buf.trim()) out.push(buf.trim());
  return out;
}

function subjectOf(stmt){
  stmt = stmt.trim();
  const m = /^([A-Za-z_][\w-]*:[\w.-]+)/.exec(stmt);
  return m ? m[1] : '';
}

function buildSubjectMap(stmts){
  const map = {};
  for(const s of stmts){
    const subj = subjectOf(s);
    if(subj && !(subj in map)) map[subj] = s;
  }
  return map;
}

function toNumToken(s){
  if(typeof s!=='string') return NaN;
  s = s.trim();
  if(/^[+-]?\d+,\d+(?:e[+-]?\d+)?$/i.test(s)) s = s.replace(',','.');
  const v = parseFloat(s);
  return isFinite(v) ? v : NaN;
}

function numIn(stmt, pred){
  const p = pred.replace(/[-/\\^$*+?.()|[\\]{}]/g,'\\$&');
  const re = new RegExp('(?:^|;|\\n|\\s)\\s*' + p + '\\s+(?:"?)' +
                        '([+-]?\\d+(?:[.,]\\d+)?(?:[eE][+-]?\\d+)?)' +
                        '(?:"?)' +
                        '(?:\\s*\\^\\^xsd:(?:decimal|double|float))?', 'i');
  const m = re.exec(stmt);
  return m ? toNumToken(m[1]) : NaN;
}
function qnameIn(stmt, pred){
  const re = new RegExp('(?:^|;|\\n|\\s)\\s*' + pred.replace(/[-/\\^$*+?.()|[\\]{}]/g,'\\$&') + '\\s+([A-Za-z_][\\w:-]*)\\b');
  const m = re.exec(stmt);
  return m ? m[1] : '';
}
function dtIn(stmt, pred){
  const re = new RegExp('(?:^|;|\\n|\\s)\\s*' + pred.replace(/[-/\\^$*+?.()|[\\]{}]/g,'\\$&') + '\\s+"([^"]+)"\\^\\^xsd:dateTime');
  const m = re.exec(stmt);
  return m ? m[1] : '';
}

function infer(ttl){
  const stmts = toStatements(ttl);
  const map = buildSubjectMap(stmts);

  const sScan = map['ex:scan1'] || '';
  const sShip = map['ex:shipment1'] || '';
  const sCur  = map['ex:currentRoute'] || '';
  const sAlt  = map['ex:altRoute'] || '';
  const sPol  = map['ex:policy'] || '';

  const depot = qnameIn(sScan, 'ex:inDepot') || 'ex:DepotX';
  const issued = dtIn(sScan, 'ex:atTime') || '2025-01-01T09:00:00Z';

  const payload = numIn(sShip, 'ex:payloadKg');
  const D1 = numIn(sCur, 'ex:distanceKm');
  const G1 = numIn(sCur, 'ex:gradientFactor');
  const D2 = numIn(sAlt, 'ex:distanceKm');
  const G2 = numIn(sAlt, 'ex:gradientFactor');
  const T  = numIn(sPol, 'ex:fuelIndexThreshold');

  const problems=[];
  if(!isFinite(payload)) problems.push('shipment1/payloadKg');
  if(!isFinite(D1)) problems.push('currentRoute/distanceKm');
  if(!isFinite(G1)) problems.push('currentRoute/gradientFactor');
  if(!isFinite(D2)) problems.push('altRoute/distanceKm');
  if(!isFinite(G2)) problems.push('altRoute/gradientFactor');
  if(!isFinite(T))  problems.push('policy/fuelIndexThreshold');

  const Wton = payload/1000;
  const FI1  = D1*Wton*G1;
  const FI2  = D2*Wton*G2;
  const showBanner = FI1 > T;
  const suggestAlt = FI1 > FI2;
  const saving = FI1 - FI2;
  const altOk = FI2 <= T;
  const comfort1 = D1 + (G1*10);
  const comfort2 = D2 + (G2*10);
  const hasC1 = comfort1 >= 40;
  const hasC2 = comfort2 >= 40;

  const envelope = {
    audience: depot,
    allowedUse: 'ui.eco.banner',
    issuedAt: issued.replace('Z','+00:00'),
    expiry: new Date(new Date(issued).getTime()+4*3600*1000).toISOString().replace('.000','').replace('Z','+00:00'),
    assertions: {
      fuelIndex_current: +FI1.toFixed(2),
      fuelIndex_alt: +FI2.toFixed(2),
      ...(showBanner ? {showEcoBanner: depot} : {}),
      ...(suggestAlt ? {suggestRoute: 'ex:altRoute'} : {}),
      ...((showBanner && suggestAlt && altOk) ? {estimatedSaving: +saving.toFixed(2)} : {}),
      ...(hasC1 ? {comfortIndex_current: +comfort1.toFixed(1)} : {}),
      ...(hasC2 ? {comfortIndex_alt: +comfort2.toFixed(1)} : {})
    }
  };
  envelope.signature = btoa(JSON.stringify(envelope)).replace(/=+$/,'');

  const dbg = [
    'Tokenized statements (' + stmts.length + '):',
    stmts.join('\n---\n'),
    '',
    'Subject map keys: ' + Object.keys(map).join(', ')
  ].join('\n');

  return {depot, issued, payload, D1, G1, D2, G2, T, FI1, FI2, showBanner, suggestAlt, saving, altOk, comfort1, comfort2, hasC1, hasC2, problems, envelope, dbg};
}

function fmt(x,n=2){ return Number.isFinite(x) ? x.toFixed(n) : String(x); }

function run(){
  const ttl = document.getElementById('ttl').value;
  const r = infer(ttl);

  const ans = [];
  if(r.problems.length){
    ans.push('⛔ Missing/invalid inputs in Turtle: ' + r.problems.join(', '));
  } else if(!(r.showBanner || r.suggestAlt)){
    ans.push('⛔ No eco‑nudge is warranted under current numbers.');
  } else {
    ans.push('✅ Insight envelope (audience‑scoped, short‑lived)\n');
    ans.push(JSON.stringify(r.envelope, null, 2));
    ans.push('\nHuman‑readable:');
    if(r.showBanner) ans.push(' • Show eco banner at ' + r.depot);
    if(r.suggestAlt) ans.push(' • Suggest alternative route (expected saving ≈ ' + fmt(r.saving,2) + ')');
  }
  document.getElementById('ans').textContent = ans.join('\n');

  const why = [];
  why.push('Inputs: payload=' + fmt(r.payload,1) + ' kg, current(D=' + fmt(r.D1,1) + ' km, G=' + fmt(r.G1,2) + '), alt(D=' + fmt(r.D2,1) + ' km, G=' + fmt(r.G2,2) + '), threshold=' + fmt(r.T,1));
  why.push('Fuel index: distanceKm × (payloadKg/1000) × gradientFactor');
  why.push('Current: ' + fmt(r.D1,1) + ' × (' + fmt(r.payload,1) + '/1000) × ' + fmt(r.G1,2) + ' = ' + fmt(r.FI1,2));
  why.push('Alt    : ' + fmt(r.D2,1) + ' × (' + fmt(r.payload,1) + '/1000) × ' + fmt(r.G2,2) + ' = ' + fmt(r.FI2,2));
  why.push('Policy : banner if current > ' + fmt(r.T,1) + '; suggest alt if alt < current; saving if alt ≤ threshold.');
  document.getElementById('why').textContent = why.join('\n');

  const chk = [];
  chk.push(r.problems.length ? '• Parse completed with missing fields. ✗' : '• Turtle parsed and all required fields present. ✓');
  chk.push(r.showBanner ? '• Banner condition holds (current > threshold). ✓' : '• Current ≤ threshold → no banner. ✓');
  chk.push(r.suggestAlt ? '• Alternative strictly better (alt < current). ✓' : '• Alternative not strictly better → no suggestion. ✓');
  chk.push((r.showBanner && r.suggestAlt && r.altOk) ? '• Saving asserted; alt ≤ threshold. ✓' : '• Saving guard check complete. ✓');
  chk.push((r.hasC1 || r.hasC2) ? '• Comfort index added where ≥ 40. ✓' : '• Comfort index skipped (< 40). ✓');
  document.getElementById('chk').textContent = chk.join('\n');

  document.getElementById('dbg').textContent = r.dbg;
  document.getElementById('status').textContent = 'Computed';
}

function downloadARC(){
  const blob = new Blob([document.getElementById('ans').textContent + '\n\n' + document.getElementById('why').textContent + '\n\n' + document.getElementById('chk').textContent],{type:'text/plain'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='eco_route_insight_output.txt'; a.click();
}

function fixEscapes(){
  const ta = document.getElementById('ttl');
  ta.value = ta.value.replace(/\\\\n/g,'\n').replace(/\\n/g,'\n').replace(/\\r\\n/g,'\n').replace(/\\r/g,'\n');
}

function loadSample(){
  document.getElementById('ttl').value = [
    '@prefix ex:   <https://example.org/ex#>.',
    '@prefix rdf:  <http://www.w3.org/1999/02/22-rdf-syntax-ns#>.',
    '@prefix xsd:  <http://www.w3.org/2001/XMLSchema#>.',
    '',
    'ex:DepotX a ex:Depot .',
    'ex:shipment1 a ex:Shipment ; ex:payloadKg 2500.0 .',
    'ex:currentRoute a ex:Route ; ex:distanceKm 42.0 ; ex:gradientFactor 1.15 .',
    'ex:altRoute a ex:Route ; ex:distanceKm 38.0 ; ex:gradientFactor 1.05 .',
    'ex:scan1 a ex:ScanEvent ; ex:inDepot ex:DepotX ; ex:atTime "2025-01-01T09:00:00Z"^^xsd:dateTime ; ex:usesRoute ex:currentRoute ; ex:forShipment ex:shipment1 .',
    'ex:policy ex:fuelIndexThreshold 120.0 .'
  ].join('\n');
}

// bootstrap: load sample and auto-run
window.addEventListener('DOMContentLoaded', () => { loadSample(); run(); });
</script>
</body>
</html>
