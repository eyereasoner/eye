<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>π (Pi) — Chudnovsky + ARC (Answer • Reason • Checks)</title>
  <style>
    :root{
      --bg:#0b0f14;--panel:#121821;--muted:#9fb2c8;--ink:#eaf2ff;--accent:#8bd3ff;
      --ok:#1fbf75;--fail:#ff5f6d;--border:#223042;--card:#0f141c;--mono:"SFMono-Regular",Consolas,Menlo,Monaco,monospace;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b0f14,#0e131c 40%,#0b0f14);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
    a{color:var(--accent)}
    header{padding:28px 20px 8px;max-width:1100px;margin:0 auto}
    header h1{margin:0 0 8px;font-weight:800;letter-spacing:-0.02em}
    header p{margin:0;color:var(--muted)}

    .wrap{max-width:1100px;margin:0 auto;padding:16px 20px 60px}

    .controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center;background:var(--panel);border:1px solid var(--border);padding:12px 12px;border-radius:16px;margin-bottom:16px}
    .controls label{font-size:14px;color:var(--muted)}
    .controls input[type=number]{width:120px;padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:#0d121a;color:var(--ink)}
    .controls button{padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:#121c2a;color:var(--ink);cursor:pointer;font-weight:600}
    .controls button.primary{background:linear-gradient(180deg,#1a7bdc,#155bb4);border-color:#0a4b9b}
    .controls .hint{font-size:12px;color:var(--muted)}

    .grid{display:grid;grid-template-columns:1.3fr .9fr;gap:16px}
    @media (max-width: 950px){.grid{grid-template-columns:1fr}}

    .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:14px 14px}
    .card h3{margin:4px 0 10px;font-size:14px;letter-spacing:.08em;text-transform:uppercase;color:var(--muted)}

    .answer{font-family:var(--mono);font-size:14px;line-height:1.45;background:var(--card);border:1px dashed #243347;padding:12px;border-radius:12px;white-space:pre-wrap;word-break:break-word}
    .small{font-size:12px;color:var(--muted)}

    .checks{display:grid;gap:8px}
    .check{border-left:6px solid var(--border);padding:8px 10px;border-radius:10px;background:var(--card);border:1px solid #243347}
    .check.ok{border-left-color:var(--ok)}
    .check.fail{border-left-color:var(--fail)}
    .check-title{font-weight:700}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .muted{color:var(--muted)}

    .footer{margin-top:14px;color:var(--muted);font-size:12px}
  </style>
</head>
<body>
  <header>
    <h1>π (Pi) — Chudnovsky + ARC</h1>
    <p>Browser‑only demo computing π to N digits with guard digits & proper rounding. ARC shows the <em>Answer</em>, the <em>Reason</em>, and verification <em>Checks</em>.</p>
  </header>

  <div class="wrap">
    <div class="controls">
      <label for="digits">Digits (decimals):</label>
      <input id="digits" type="number" min="1" max="2000" step="1" value="100" />
      <button id="run" class="primary">Run</button>
      <button id="copy">Copy answer</button>
      <button id="save">Save .txt</button>
      <span class="hint">Up to 2000 digits. Uses ~20 guard digits for rounding.</span>
    </div>

    <div class="grid">
      <section class="card">
        <h3>Answer</h3>
        <div id="answer" class="answer">—</div>
        <div class="row" style="margin-top:8px">
          <span class="small" id="meta">–</span>
        </div>
      </section>

      <section class="card">
        <h3>Reason</h3>
        <div id="reason" class="small">—</div>
        <div class="footer">Method: Chudnovsky series with big‑integer fixed‑point arithmetic; guard digits then round once and trim.</div>
      </section>
    </div>

    <section class="card" style="margin-top:16px">
      <h3>Checks</h3>
      <div id="checks" class="checks"></div>
    </section>

    <section class="card" style="margin-top:16px">
      <h3>What is this?</h3>
      <p class="small">A self‑contained page that computes π using the Chudnovsky series. It works entirely in your browser (no libraries). The <strong>Checks</strong> include a short prefix check and a stability check that recomputes with more guard digits and asserts the first N digits are unchanged.</p>
    </section>
  </div>

<script>
// ===== BigInt helpers =====
function isqrt(n){ // Integer square root via Newton's method
  if (n < 0n) throw new Error('isqrt of negative');
  if (n < 2n) return n;
  let x = n, y = (n >> 1n) + 1n;
  while (y < x) { x = y; y = (y + n / y) >> 1n; }
  return x;
}

function formatScaled(S, prec){
  const s = S.toString();
  const point = s.length - prec;
  return (point <= 0) ? ("0." + "0".repeat(-point) + s) : (s.slice(0, point) + "." + s.slice(point));
}

// ===== π via Chudnovsky with guard digits & rounding =====
function chudnovskyPi(digits, guard = 20){
  if (!Number.isFinite(digits) || digits < 1) throw new Error("digits must be >= 1");
  const A = 13591409n, B = 545140134n;
  const C3 = 262537412640768000n; // 640320^3
  const K = 426880n; // K * sqrt(10005) / sum = pi

  const terms = Math.ceil((digits + guard) / 14) + 2; // ~14 digits per term
  const prec = digits + guard;
  const scale = 10n ** BigInt(prec);

  // sqrt(10005) scaled by 10^prec (floor)
  const sqrt10005 = isqrt(10005n * scale * scale);

  // Sum S = Σ (-1)^k * M(k) * (A + Bk) / C3^k  (scaled by 10^prec)
  let S = 0n;
  let M = 1n;   // M(0)=1
  let X = 1n;   // C3^0
  let sign = 1n;

  for (let k = 0; k < terms; k++){
    const kk = BigInt(k);
    const L = A + B * kk;

    // term scaled: (M * L / X) * 10^prec
    const term = (M * L * scale) / X;
    S += sign * term;

    // advance to k+1 with exact ratio for M
    const k1 = kk + 1n;
    const sixk = 6n * kk;
    const num = (sixk + 1n) * (sixk + 2n) * (sixk + 3n) * (sixk + 4n) * (sixk + 5n) * (sixk + 6n);
    const den = (3n * kk + 1n) * (3n * kk + 2n) * (3n * kk + 3n) * (k1 * k1 * k1);
    M = (M * num) / den; // exact division under Chudnovsky
    X = X * C3;
    sign = -sign;
  }

  // π_scaled_full = floor( K * sqrt(10005) / S )  (scaled by 10^prec)
  let piScaled = (K * sqrt10005) / S;

  // Round to requested digits by trimming guard places
  if (guard > 0){
    const half = 5n * 10n ** BigInt(guard - 1);
    piScaled = (piScaled + half) / (10n ** BigInt(guard));
  }

  const text = formatScaled(piScaled, digits);
  return { text, raw: piScaled, precUsed: prec, terms };
}

// ===== Checks =====
// A conservative, well-known 100-digit reference prefix (including "3.")
const PI_PREFIX_100 =
  "3.14159265358979323846264338327950288419716939937510" +
  "58209749445923078164062862089986280348253421170679";

function runChecks(answerText, digits){
  const checks = [];
  const clean = answerText.replace(/[^0-9.]/g, "");

  // 1) Prefix check (up to 100 digits)
  const upto = Math.min(clean.length, PI_PREFIX_100.length);
  const okPrefix = clean.slice(0, upto) === PI_PREFIX_100.slice(0, upto);
  checks.push({
    name: `Prefix check (≤ ${Math.max(0, upto - 2)} decimals)`,
    ok: okPrefix,
    detail: okPrefix ? "prefix matches" : `mismatch at position ${[...clean].findIndex((c,i)=>c!==PI_PREFIX_100[i])}`
  });

  // 2) Stability check: recompute with guard+10 and compare first N digits
  const a = clean;
  const b = chudnovskyPi(digits, 30).text.replace(/[^0-9.]/g, "");
  const targetLen = 2 + digits; // "3." + digits
  const okStable = a.slice(0, targetLen) === b.slice(0, targetLen);
  checks.push({
    name: "Stability check (guard +10)",
    ok: okStable,
    detail: okStable ? "first N digits unchanged" : "first N digits changed with more guard"
  });

  return checks;
}

// ===== UI glue =====
const $ = (sel)=>document.querySelector(sel);
const digitsInput = $('#digits');
const runBtn = $('#run');
const copyBtn = $('#copy');
const saveBtn = $('#save');
const answerBox = $('#answer');
const reasonBox = $('#reason');
const checksBox = $('#checks');
const metaLine = $('#meta');

function renderChecks(list){
  checksBox.innerHTML = list.map(r=>{
    const cls = r.ok ? 'ok' : 'fail';
    const icon = r.ok ? '✓' : '✗';
    return `<div class="check ${cls}"><div class="check-title">${icon} ${r.name}</div><div class="muted">${r.detail}</div></div>`;
  }).join('');
}

function prettyBreak(s){
  // insert a soft break every 100 chars past the decimal for readability
  const i = s.indexOf('.');
  if (i < 0) return s;
  const head = s.slice(0, i+1);
  const tail = s.slice(i+1);
  return head + tail.replace(/.{1,100}/g, '$&\n');
}

async function compute(){
  const n = Math.max(1, Math.min(2000, (parseInt(digitsInput.value)||0)));
  const start = performance.now();
  let out;
  try{
    out = chudnovskyPi(n, 20);
  }catch(e){
    answerBox.textContent = 'Error: ' + e.message;
    reasonBox.textContent = '';
    renderChecks([]);
    metaLine.textContent = '';
    return;
  }
  const ms = performance.now() - start;
  answerBox.textContent = prettyBreak(out.text);
  reasonBox.textContent = `Chudnovsky series; terms = ${out.terms}; guard = 20; precision = ${out.precUsed} digits; time = ${ms.toFixed(0)} ms.`;
  metaLine.textContent = `"3." + ${n} decimals (rounded)`;
  const results = runChecks(out.text, n);
  renderChecks(results);
}

runBtn.addEventListener('click', compute);
window.addEventListener('load', compute);

copyBtn.addEventListener('click', async ()=>{
  try{
    await navigator.clipboard.writeText(answerBox.textContent.replace(/\n/g,''));
    copyBtn.textContent = 'Copied!'; setTimeout(()=>copyBtn.textContent='Copy answer',1000);
  }catch{ copyBtn.textContent = 'Copy failed'; setTimeout(()=>copyBtn.textContent='Copy answer',1200); }
});

saveBtn.addEventListener('click', ()=>{
  const blob = new Blob([answerBox.textContent + "\n"], {type:'text/plain'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `pi_${(parseInt(digitsInput.value)||0)}_digits.txt`;
  document.body.appendChild(a); a.click(); a.remove();
});
</script>
</body>
</html>

