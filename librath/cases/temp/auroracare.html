<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AuroraCare ‚Äî Purpose-based Medical Data Exchange (ODRL demo)</title>
  <style>
    :root {
      --bg: #f7f9fc;
      --card: #ffffff;
      --muted: #5b6470;
      --text: #0b1020;
      --accent: #0b5fff;
      --good: #107e3e;
      --bad: #c62828;
      --warn: #b26a00;
      --border: #e5e7eb;
      --shadow: rgba(2, 8, 23, 0.06);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 32px;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(800px 500px at 10% -10%, #ffffff 0%, var(--bg) 60%, #eef2f7 100%);
      color: var(--text);
    }
    h1 { font-weight: 800; letter-spacing: -0.02em; margin: 0 0 8px; }
    h2 { margin: 24px 0 8px; font-weight: 700; }
    p { color: var(--muted); line-height: 1.6; }
    .grid { display: grid; grid-template-columns: 1.1fr 1fr; gap: 24px; align-items: start; }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px 18px;
      box-shadow: 0 12px 30px var(--shadow);
    }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    label { font-size: 13px; color: var(--muted); display: grid; gap: 6px; }
    input[type="text"], select {
      background: #fff; color: var(--text);
      border: 1px solid var(--border); border-radius: 10px; padding: 10px 12px;
      outline: none;
    }
    input[type="text"]:focus, select:focus { border-color: #bfd3ff; box-shadow: 0 0 0 4px #e7f0ff; }
    .chips { display: flex; gap: 8px; flex-wrap: wrap; }
    .chip { border: 1px solid var(--border); border-radius: 999px; padding: 6px 10px; background: #fff; color: var(--text); }
    .chip input { margin-right: 6px; }
    .muted { color: var(--muted); }
    button {
      background: linear-gradient(180deg, #3b82f6, #2563eb);
      border: none; color: white; padding: 10px 14px; border-radius: 12px;
      font-weight: 700; cursor: pointer;
      box-shadow: 0 8px 18px rgba(37,99,235,0.35);
    }
    button.secondary { background: linear-gradient(180deg, #7c3aed, #6d28d9); box-shadow: 0 8px 18px rgba(124,58,237,0.25); }
    button.ghost { background: transparent; border: 1px solid var(--border); color: var(--text); box-shadow: none; }
    .result {
      display: grid; grid-template-columns: 1fr; gap: 12px; margin-top: 8px;
    }
    .answer {
      font-size: 14px; font-weight: 800; letter-spacing: .06em;
      padding: 8px 12px; border-radius: 10px; width: fit-content;
      border: 1px solid var(--border);
    }
    .answer.permit { background: #e9f7ef; color: var(--good); }
    .answer.deny { background: #fdecea; color: var(--bad); }
    .checks { border-top: 1px dashed var(--border); padding-top: 8px; }
    .check-item { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px dashed #f0f2f7; }
    .ok { color: var(--good); }
    .fail { color: var(--bad); }
    .skip { color: var(--muted); }
    .info { color: var(--warn); }
    details { border: 1px solid var(--border); border-radius: 10px; padding: 8px 12px; background: #fafafa; }
    summary { cursor: pointer; }
    code, pre { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    pre { background: #f3f4f6; color: #111827; padding: 10px; border-radius: 10px; border: 1px solid var(--border); overflow: auto; }
    .policy { font-size: 13px; }
    .scenario-buttons { display: flex; gap: 8px; flex-wrap: wrap; }
    .tiny { font-size: 12px; }
    a { color: var(--accent); }
    @media (max-width: 980px) { .grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <header style="margin-bottom:20px">
    <h1>üå§Ô∏è AuroraCare</h1>
    <p class="muted">Purpose-based medical data exchange ‚Ä¢ ODRL-driven authorization ‚Ä¢ ‚ÄúAnswer / Reason why / Check‚Äù output</p>
  </header>

  <div class="grid">
    <section class="card">
      <h2>Request</h2>
      <div class="row">
        <label>Requester ID<input id="requesterId" type="text" value="clinician_alba" /></label>
        <label>Role
          <select id="role">
            <option value="clinician">CLINICIAN</option>
            <option value="data_user">DATA_USER</option>
          </select>
        </label>
        <label>Subject ID<input id="subjectId" type="text" value="ruben" /></label>
      </div>
      <div class="row">
        <label>Purpose
          <select id="purpose">
            <option value="primary-care">primary-care</option>
            <option value="remote-consult">remote-consult</option>
            <option value="diabetes-qi">diabetes-qi</option>
            <option value="research">research</option>
            <option value="insurance-pricing">insurance-pricing</option>
          </select>
        </label>
        <label>Environment
          <select id="environment">
            <option value="api_gateway">api_gateway</option>
            <option value="secure_env">secure_env</option>
          </select>
        </label>
      </div>
      <div style="margin-top:8px">
        <label>Categories</label>
        <div id="catBox" class="chips"></div>
      </div>

      <div style="margin-top:12px" class="row">
        <button id="evalBtn">Evaluate</button>
        <button class="ghost tiny" id="copyBtn">Copy result JSON</button>
      </div>

      <h2 style="margin-top:22px">Consent & Care-team</h2>
      <div class="row">
        <label>Consent (ruben ‚Üí diabetes-qi)
          <select id="consentQi">
            <option value="unset">unset</option>
            <option value="opt_in" selected>opt-in</option>
            <option value="opt_out">opt-out</option>
          </select>
        </label>
        <label>Care-team link (clinician_alba ‚Üî ruben)
          <select id="careteamLink">
            <option value="linked" selected>linked</option>
            <option value="unlinked">unlinked</option>
          </select>
        </label>
      </div>

      <h2 style="margin-top:22px">Scenarios</h2>
      <div class="scenario-buttons">
        <button class="secondary tiny" data-scenario="A">A: Primary care</button>
        <button class="secondary tiny" data-scenario="B">B: Secondary (opt-in)</button>
        <button class="secondary tiny" data-scenario="C">C: Secondary (opt-out)</button>
        <button class="secondary tiny" data-scenario="D">D: Prohibited (insurance)</button>
      </div>
    </section>

    <section class="card">
      <h2>Decision</h2>
      <div id="result" class="result">
        <div class="muted tiny">Fill the form and click <b>Evaluate</b>.</div>
      </div>

      <details style="margin-top:12px">
        <summary>Policies (ODRL-like)</summary>
        <div class="policy">
          <pre id="policyDump"></pre>
        </div>
      </details>

      <details style="margin-top:8px">
        <summary>Machine Trace (debug)</summary>
        <pre id="traceDump"></pre>
      </details>
    </section>
  </div>

  <footer style="margin-top:24px; text-align:center" class="muted tiny">
    AuroraCare prototype ‚Äî ODRL-inspired evaluator (eq, isAnyOf, isAllOf), ‚ÄúAnswer / Reason why / Check‚Äù output. No backend required.
  </footer>

<script>
// ----------------------------- Data model -----------------------------
const Categories = ["PATIENT_SUMMARY","LAB_RESULTS","IMAGING_REPORT","DISCHARGE_REPORT","EPRESCRIPTION"];
function catCheckboxes() {
  const box = document.getElementById("catBox");
  box.innerHTML = "";
  Categories.forEach(c => {
    const lab = document.createElement("label");
    lab.className = "chip";
    lab.innerHTML = `<input type="checkbox" value="${c}" ${c==="PATIENT_SUMMARY" ? "checked" : ""}/> ${c}`;
    box.appendChild(lab);
  });
}
catCheckboxes();

// Policies (ODRL-like JSON)
const EHDS = "https://example.org/odrl/ehds#";
const policies = [
  {
    "@context": ["http://www.w3.org/ns/odrl.jsonld", {"ehds": EHDS}],
    uid: "urn:policy:primary-care-001",
    type: "Policy",
    permission: [{
      uid: "urn:rule:pc-1",
      action: "use",
      target: "urn:asset:ehr",
      constraint: [
        { leftOperand: "ehds:purpose",      operator: "eq",      rightOperand: "primary-care" },
        { leftOperand: "ehds:assigneeRole", operator: "eq",      rightOperand: "clinician" },
        { leftOperand: "ehds:category",     operator: "isAnyOf", rightOperand: ["PATIENT_SUMMARY"] }
      ]
    }]
  },
  {
    "@context": ["http://www.w3.org/ns/odrl.jsonld", {"ehds": EHDS}],
    uid: "urn:policy:HDAB-2025-001",
    type: "Policy",
    prohibition: [{
      uid: "urn:rule:deny-insurance",
      action: "use",
      constraint: [{ leftOperand: "ehds:purpose", operator: "eq", rightOperand: "insurance-pricing" }]
    }],
    permission: [{
      uid: "urn:rule:qi-1",
      action: "use",
      target: "urn:asset:ehr",
      constraint: [
        { leftOperand: "ehds:purpose",      operator: "eq",      rightOperand: "diabetes-qi" },
        { leftOperand: "ehds:environment",  operator: "eq",      rightOperand: "secure_env" },
        { leftOperand: "ehds:category",     operator: "isAllOf", rightOperand: ["LAB_RESULTS","PATIENT_SUMMARY"] }
      ],
      duty: [{ action: "ehds:requireConsent" }, { action: "ehds:noExfiltration" }]
    }]
  }
];
document.getElementById("policyDump").textContent = JSON.stringify(policies, null, 2);

// ----------------------------- Services (stubs) -----------------------------
const ConsentService = {
  store: {}, // { subject: { purposeSlug: true|false } }
  set(subject, purposeSlug, allowed) { (this.store[subject] ??= {})[purposeSlug] = allowed; },
  get(subject, purposeSlug) { return (this.store[subject] ?? {})[purposeSlug]; }
};
const CareTeamService = {
  links: new Set([ "clinician_alba|ruben" ]),
  link(clinician, subject) { this.links.add(`${clinician}|${subject}`); },
  isLinked(clinician, subject) { return this.links.has(`${clinician}|${subject}`); }
};

// reflect UI defaults
function syncConsentAndCareteamFromUI() {
  const c = document.getElementById("consentQi").value;
  if (c === "opt_in") ConsentService.set("ruben","diabetes-qi", true);
  else if (c === "opt_out") ConsentService.set("ruben","diabetes-qi", false);
  else { if (ConsentService.store["ruben"]) delete ConsentService.store["ruben"]["diabetes-qi"]; }

  const link = document.getElementById("careteamLink").value;
  if (link === "linked") CareTeamService.link("clinician_alba","ruben");
  else CareTeamService.links.delete("clinician_alba|ruben");
}
syncConsentAndCareteamFromUI();

// ----------------------------- ODRL Engine -----------------------------
const ODRLEngine = {
  ACTION_USE: "use",

  match(req, policy) {
    const trace = [];
    const obligations = [];

    // Prohibitions
    for (const pr of (policy.prohibition ?? [])) {
      if (!this._actionOk(pr)) continue;
      const [ok, tr] = this._constraintsHold(req, pr.constraint ?? []);
      trace.push(...this._prefix(policy, tr));
      if (ok) {
        trace.push(`${policy.uid}:deny:odrl:prohibition_matched`);
        return [false, trace, obligations];
      }
    }
    // Permissions
    for (const pm of (policy.permission ?? [])) {
      if (!this._actionOk(pm)) continue;
      const [ok, tr] = this._constraintsHold(req, pm.constraint ?? []);
      trace.push(...this._prefix(policy, tr));
      if (ok) {
        for (const d of (pm.duty ?? [])) {
          if (d.action) obligations.push(`duty:${d.action}`);
        }
        trace.push(`${policy.uid}:permit:odrl:permission_matched`);
        return [true, trace, obligations];
      }
    }
    trace.push(`${policy.uid}:deny:odrl:no_permission_matched`);
    return [false, trace, obligations];
  },

  _actionOk(rule) {
    const a = (typeof rule.action === "string") ? rule.action : (rule.action?.id || rule.action?.["@id"]);
    return a === this.ACTION_USE || a === `http://www.w3.org/ns/odrl/2/${this.ACTION_USE}`;
  },

  _constraintsHold(req, constraints) {
    const trace = [];
    for (const c of constraints) {
      const { ok, lhs } = this._constraintOk(req, c.leftOperand, c.operator, c.rightOperand);
      if (!ok) {
        trace.push(`constraint_failed:${c.leftOperand}:${c.operator}:lhs=${JSON.stringify(lhs)},rightOperand=${JSON.stringify(c.rightOperand)}`);
        return [false, trace];
      }
      trace.push(`constraint_ok:${c.leftOperand}:${c.operator}:lhs=${JSON.stringify(lhs)},rightOperand=${JSON.stringify(c.rightOperand)}`);
    }
    return [true, trace];
  },

  _constraintOk(req, lop, op, rop) {
    let lhs = null;
    if (lop === "ehds:purpose" || lop === `${EHDS}purpose`) {
      lhs = req.purpose;
      return { ok: this._op(lhs, op, rop), lhs };
    }
    if (lop === "ehds:environment" || lop === `${EHDS}environment`) {
      lhs = req.environment; return { ok: this._op(lhs, op, rop), lhs };
    }
    if (lop === "ehds:assigneeRole" || lop === `${EHDS}assigneeRole`) {
      lhs = req.requester_role; return { ok: this._op(lhs, op, rop), lhs };
    }
    if (lop === "ehds:category" || lop === `${EHDS}category`) {
      lhs = [...req.categories]; return { ok: this._op(lhs, op, rop), lhs };
    }
    return { ok: false, lhs };
  },

  _op(lhs, op, rop) {
    if (op === "eq") return lhs === rop;
    if (op === "isAnyOf") {
      if (Array.isArray(rop)) return Array.isArray(lhs) ? lhs.some(x => rop.includes(x)) : rop.includes(lhs);
      return false;
    }
    if (op === "isAllOf") {
      if (Array.isArray(lhs) && Array.isArray(rop)) return lhs.every(x => rop.includes(x));
      return false;
    }
    return false;
  },

  _prefix(policy, lines) { return lines.map(ln => `${policy.uid}:${ln}`); }
};

// ----------------------------- PDP logic -----------------------------
const PDP = {
  PROHIBITED_PURPOSES: new Set(["insurance-pricing"]),

  decide(req) {
    const trace = [];
    let obligations = [];

    // R0: prohibited purpose
    if (this.PROHIBITED_PURPOSES.has(req.purpose)) {
      trace.push("deny:prohibited_purpose");
      return this._finalize(req, "DENY", "Denied: the requested purpose (insurance pricing) is prohibited by policy.", trace, obligations);
    }

    // Primary uses
    if (req.purpose === "primary-care" || req.purpose === "remote-consult") {
      if (req.requester_role !== "clinician") {
        trace.push("deny:primary_only_for_clinicians");
        return this._finalize(req, "DENY", "Denied: primary-care access is limited to clinicians.", trace, obligations);
      }
      trace.push("ok:role=CLINICIAN");
      if (!CareTeamService.isLinked(req.requester_id, req.subject_id)) {
        trace.push("deny:not_in_care_team");
        return this._finalize(req, "DENY", "Denied: requester is not linked to the patient's care team.", trace, obligations);
      }
      trace.push("ok:careteam_link");
      // evaluate policies
      const [ok, tr, obl] = this._evalPolicies(req);
      trace.push(...tr); obligations.push(...obl);
      if (ok) {
        trace.push("permit:primary_care_allowed");
        return this._finalize(req, "PERMIT", "Permitted: clinician in the patient's care team, and the primary-care policy matched (purpose=primary-care, category includes requested items).", trace, obligations);
      }
      return this._finalize(req, "DENY", "Denied: no primary-care policy matched for the requested categories/environment.", trace, obligations);
    }

    // Secondary uses
    const pref = ConsentService.get(req.subject_id, req.purpose);
    if (pref === false) {
      trace.push("deny:subject_opted_out");
      return this._finalize(req, "DENY", "Denied: the data subject has opted out of this secondary use.", trace, obligations);
    }
    if (pref === undefined) {
      trace.push("deny:no_subject_opt_in");
      return this._finalize(req, "DENY", "Denied: no explicit opt-in for this secondary use.", trace, obligations);
    }
    trace.push(`ok:subject_opted_in:purpose=${req.purpose}`);

    const [ok, tr, obl] = this._evalPolicies(req);
    trace.push(...tr); obligations.push(...obl);
    if (!ok) {
      return this._finalize(req, "DENY", "Denied: no ODRL permission matched (purpose, environment, or categories out of scope).", trace, obligations);
    }
    return this._finalize(req, "PERMIT", "Permitted: subject opted in and an ODRL policy matched (purpose and requested categories in a secure environment). Duties are enforced as obligations.", trace, obligations);
  },

  _evalPolicies(req) {
    const agg = []; let obligations = [];
    for (const pol of policies) {
      const [ok, tr, obl] = ODRLEngine.match(req, pol);
      agg.push(...tr);
      if (ok) { obligations.push(...obl); return [true, agg, obligations]; }
    }
    return [false, agg, obligations];
  },

  _finalize(req, answer, reason_why, trace, obligations) {
    const check = this._checks(req, answer, trace, obligations);
    const decision = { Answer: answer, "Reason why": reason_why, Check: check };
    // show
    renderDecision(decision, trace);
    return decision;
  },

  _checks(req, answer, trace, obligations) {
    // policy summary helper
    const summary = () => {
      let matched = null, duties = [], okAny = false, prohibition = false;
      for (const pol of policies) {
        const [ok, tr, obl] = ODRLEngine.match(req, pol);
        if (tr.some(t => t.endsWith(":deny:odrl:prohibition_matched"))) prohibition = true;
        if (ok && !okAny) { okAny = true; matched = pol; duties = obl; }
      }
      return { okAny, matched, duties, prohibition };
    };
    const { okAny, matched, duties, prohibition } = summary();
    const hasCareteam = CareTeamService.isLinked(req.requester_id, req.subject_id);
    const hasOptin = ConsentService.get(req.subject_id, req.purpose) === true;

    const out = {};

    // C1
    if (this.PROHIBITED_PURPOSES.has(req.purpose)) out["C1_prohibited_denied"] = (answer === "DENY") ? "OK - denied prohibited purpose" : "FAIL - prohibited purpose was not denied";
    else out["C1_prohibited_denied"] = "SKIPPED - not a prohibited purpose";

    // C2/C3
    if (req.purpose === "primary-care" || req.purpose === "remote-consult") {
      if (req.requester_role !== "clinician") out["C2_primary_role"] = (answer === "DENY") ? "OK - non-clinician denied" : "FAIL - non-clinician permitted";
      else out["C2_primary_role"] = "OK - clinician";
      out["C3_primary_careteam"] = (hasCareteam && answer === "PERMIT") ? "OK - care-team linked" : ((!hasCareteam && answer === "DENY") ? "OK - denied due to missing care-team" : "FAIL - care-team rule inconsistent with answer");
    } else {
      out["C2_primary_role"] = "SKIPPED"; out["C3_primary_careteam"] = "SKIPPED";
    }

    // C4
    if (!(req.purpose === "primary-care" || req.purpose === "remote-consult") && req.purpose !== "insurance-pricing") {
      const expectPermit = hasOptin && okAny;
      out["C4_secondary_optin_and_policy"] =
        (answer === "PERMIT")
          ? (expectPermit ? "OK - opt-in present and policy matched" : "FAIL - permitted without opt-in and matching policy")
          : (!expectPermit ? "OK - denied because opt-in missing or no policy match" : "FAIL - denied despite opt-in and policy match");
    } else out["C4_secondary_optin_and_policy"] = "SKIPPED";

    // C5: category scope if matched and permitted
    if (matched && answer === "PERMIT") {
      const perms = matched.permission ?? [];
      let catOk = true, msg = "";
      if (perms.length) {
        const cons = perms[0].constraint ?? [];
        const catCons = cons.filter(c => c.leftOperand === "ehds:category" || c.leftOperand === `${EHDS}category`);
        if (catCons.length) {
          const op = catCons[0].operator, allowed = catCons[0].rightOperand ?? [];
          const reqCats = [...req.categories];
          if (op === "isAllOf") catOk = reqCats.every(x => allowed.includes(x));
          else if (op === "isAnyOf") catOk = reqCats.some(x => allowed.includes(x));
          msg = `operator=${op}, allowed=${JSON.stringify(allowed)}, requested=${JSON.stringify(reqCats)}`;
        }
      }
      out["C5_category_scope"] = catOk ? `OK - ${msg}` : `FAIL - out of scope: ${msg}`;
    } else out["C5_category_scope"] = "SKIPPED";

    // C6 prohibition
    if (prohibition) out["C6_prohibition_blocks"] = (answer === "DENY") ? "OK - denied due to prohibition" : "FAIL - permitted despite prohibition";
    else out["C6_prohibition_blocks"] = "SKIPPED - no prohibition matched";

    // C7 trace consistency
    if (answer === "PERMIT") {
      const okTrace = trace.some(l => l.endsWith(":permit:odrl:permission_matched")) || trace.includes("permit:primary_care_allowed");
      out["C7_trace_consistency"] = okTrace ? "OK - trace shows matching permission" : "FAIL - missing permission marker in trace";
    } else out["C7_trace_consistency"] = "SKIPPED";

    // C8 duties presence (informational)
    out["C8_duties_present"] = duties.length ? `INFO - duties attached: ${duties.join(", ")}` : "SKIPPED - no matched policy or no duties";

    return out;
  }
};

// ----------------------------- UI / glue -----------------------------
function readRequestFromUI() {
  const requester_id = document.getElementById("requesterId").value.trim();
  const role = document.getElementById("role").value === "clinician" ? "clinician" : "data_user";
  const subject_id = document.getElementById("subjectId").value.trim();
  const purpose = document.getElementById("purpose").value;
  const environment = document.getElementById("environment").value;
  const categories = [...document.querySelectorAll("#catBox input:checked")].map(i => i.value);
  return {
    request_id: (crypto.randomUUID ? crypto.randomUUID() : String(Math.random()).slice(2)),
    requester_id,
    requester_role: (role === "clinician" ? "clinician" : "data_user"),
    subject_id,
    purpose,
    categories,
    environment,
    time: new Date().toISOString()
  };
}

function renderDecision(decision, trace) {
  const el = document.getElementById("result");
  el.innerHTML = "";
  const answer = document.createElement("div");
  answer.className = "answer " + (decision.Answer === "PERMIT" ? "permit" : "deny");
  answer.textContent = decision.Answer;
  const reason = document.createElement("div");
  reason.textContent = decision["Reason why"];
  el.appendChild(answer);
  el.appendChild(reason);

  const checks = document.createElement("div");
  checks.className = "checks";
  for (const [k,v] of Object.entries(decision.Check)) {
    const row = document.createElement("div"); row.className = "check-item";
    const key = document.createElement("div"); key.textContent = k;
    const val = document.createElement("div");
    val.textContent = v;
    if (v.startsWith("OK")) val.className = "ok";
    else if (v.startsWith("FAIL")) val.className = "fail";
    else if (v.startsWith("SKIPPED")) val.className = "skip";
    else if (v.startsWith("INFO")) val.className = "info";
    row.appendChild(key); row.appendChild(val);
    checks.appendChild(row);
  }
  el.appendChild(checks);

  document.getElementById("traceDump").textContent = trace.join("\n");
}

document.getElementById("evalBtn").addEventListener("click", () => {
  syncConsentAndCareteamFromUI();
  const req = readRequestFromUI();
  PDP.decide(req);
});

document.getElementById("copyBtn").addEventListener("click", async () => {
  const req = readRequestFromUI();
  const result = PDP.decide(req);
  await navigator.clipboard.writeText(JSON.stringify(result, null, 2));
  alert("Decision JSON copied to clipboard.");
});

// Scenario buttons
document.querySelectorAll("[data-scenario]").forEach(btn => {
  btn.addEventListener("click", (e) => {
    const id = e.currentTarget.getAttribute("data-scenario");
    const roleSel = document.getElementById("role");
    const purposeSel = document.getElementById("purpose");
    const envSel = document.getElementById("environment");
    const consentSel = document.getElementById("consentQi");
    const careSel = document.getElementById("careteamLink");
    // reset categories
    document.querySelectorAll("#catBox input").forEach(i => i.checked = false);

    if (id === "A") {
      document.getElementById("requesterId").value = "clinician_alba";
      roleSel.value = "clinician";
      document.getElementById("subjectId").value = "ruben";
      purposeSel.value = "primary-care";
      envSel.value = "api_gateway";
      document.querySelector("#catBox input[value='PATIENT_SUMMARY']").checked = true;
      consentSel.value = "unset"; careSel.value = "linked";
    }
    if (id === "B") {
      document.getElementById("requesterId").value = "data_user_qi";
      roleSel.value = "data_user";
      document.getElementById("subjectId").value = "ruben";
      purposeSel.value = "diabetes-qi";
      envSel.value = "secure_env";
      document.querySelector("#catBox input[value='LAB_RESULTS']").checked = true;
      consentSel.value = "opt_in"; careSel.value = "linked";
    }
    if (id === "C") {
      document.getElementById("requesterId").value = "data_user_qi";
      roleSel.value = "data_user";
      document.getElementById("subjectId").value = "ruben";
      purposeSel.value = "diabetes-qi";
      envSel.value = "secure_env";
      document.querySelector("#catBox input[value='LAB_RESULTS']").checked = true;
      consentSel.value = "opt_out"; careSel.value = "linked";
    }
    if (id === "D") {
      document.getElementById("requesterId").value = "insurer_bot";
      roleSel.value = "data_user";
      document.getElementById("subjectId").value = "ruben";
      purposeSel.value = "insurance-pricing";
      envSel.value = "secure_env";
      document.querySelector("#catBox input[value='PATIENT_SUMMARY']").checked = true;
      consentSel.value = "unset"; careSel.value = "unlinked";
    }
    // re-sync backing stores
    syncConsentAndCareteamFromUI();
    // auto-evaluate
    document.getElementById("evalBtn").click();
  });
});
</script>
</body>
</html>
